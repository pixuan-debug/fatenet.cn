# 线上数据获取方案

## 1. 线上数据源及数据范围

### 1.1 主要数据源
- **API服务**：`http://localhost:3000/api/v1`
- **数据库**：SQLite数据库（位于`api/database/articles.db`）
- **静态文件**：`articles.json`（初始数据文件）

### 1.2 数据范围
- **文章数据**：所有分类的文章，包括标题、内容、分类、浏览量、点赞数等
- **同步事件**：用户产生的浏览和点赞事件记录
- **统计数据**：总浏览量、总点赞数、总留言数等

## 2. 数据获取方法和步骤

### 2.1 环境准备
1. **安装Node.js**：确保环境中已安装Node.js 14+版本
2. **安装依赖**：
   ```bash
   cd api
   npm init -y
   npm install express cors sqlite3 body-parser jsonwebtoken
   ```

### 2.2 启动API服务
```bash
cd api
node server.js
```

### 2.3 API调用流程

#### 2.3.1 健康检查
- **请求URL**：`GET http://localhost:3000/api/v1/health`
- **作用**：验证API服务是否正常运行
- **预期响应**：
  ```json
  {
    "code": 200,
    "message": "API服务运行正常",
    "data": {
      "timestamp": "2025-12-25T00:00:00.000Z",
      "version": "1.0.0",
      "status": "healthy"
    }
  }
  ```

#### 2.3.2 获取文章列表
- **请求URL**：`GET http://localhost:3000/api/v1/articles`
- **作用**：获取所有文章的最新数据
- **预期响应**：
  ```json
  {
    "code": 200,
    "message": "成功获取文章列表",
    "data": {
      "articles": [
        {
          "id": 1,
          "article_id": 1,
          "category": "basic-theory",
          "title": "什么是八字？",
          "content": "...",
          "likes": 2,
          "views": 15,
          "last_updated": "2025-12-25T00:00:00.000Z",
          "version": 3
        },
        // 更多文章...
      ],
      "total": 7
    }
  }
  ```

#### 2.3.3 获取单篇文章
- **请求URL**：`GET http://localhost:3000/api/v1/articles/{articleId}?category={category}`
- **参数**：
  - `articleId`：文章ID
  - `category`：文章分类（可选）
- **作用**：获取指定文章的详细数据

#### 2.3.4 管理员获取所有文章
- **请求URL**：`GET http://localhost:3000/api/v1/admin/articles`
- **认证**：需要在请求头中添加`Authorization: Bearer {token}`
- **作用**：获取按分类分组的所有文章数据

#### 2.3.5 登录获取Token
- **请求URL**：`POST http://localhost:3000/api/v1/auth/login`
- **请求体**：
  ```json
  {
    "username": "admin",
    "password": "admin123"
  }
  ```
- **作用**：获取管理员认证Token

## 3. 权限验证流程

### 3.1 公开API
- 不需要认证：
  - `/api/v1/health`
  - `/api/v1/articles`
  - `/api/v1/articles/{articleId}`
  - `/api/v1/articles/sync`

### 3.2 管理员API
- 需要认证：
  - `/api/v1/sync/events`
  - `/api/v1/admin/articles`
- **认证方式**：JWT Token
- **获取Token**：通过`/api/v1/auth/login`接口

## 4. 数据完整性和准确性校验

### 4.1 数据完整性校验
- 检查返回数据是否包含所有必要字段
- 验证数据格式是否符合预期
- 检查文章数量是否与实际一致

### 4.2 数据准确性校验
- 验证浏览量和点赞数是否为非负整数
- 检查文章分类是否在允许范围内
- 验证日期格式是否正确

### 4.3 数据一致性校验
- 比较不同数据源的数据是否一致
- 验证同步事件记录是否完整
- 检查版本号是否递增

## 5. 数据格式和返回要求

### 5.1 统一响应格式
```json
{
  "code": 200,
  "message": "成功消息",
  "data": {
    // 具体数据
  },
  "requestId": "唯一请求ID" // 可选
}
```

### 5.2 文章数据格式
```json
{
  "id": 1,
  "title": "文章标题",
  "content": "文章内容",
  "category": "basic-theory",
  "date": "2025-12-25",
  "likes": 2,
  "views": 15,
  "isFeatured": true,
  "images": [],
  "version": 3,
  "lastUpdatedLocal": "2025-12-25T00:00:00.000Z"
}
```

### 5.3 统计数据格式
```json
{
  "totalArticles": 7,
  "totalViews": 100,
  "totalLikes": 20,
  "totalComments": 5
}
```

## 6. 数据获取示例代码

### 6.1 前端JavaScript示例
```javascript
// 获取文章列表
async function fetchArticles() {
  try {
    const response = await fetch('http://localhost:3000/api/v1/articles', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      cache: 'no-cache'
    });
    
    if (!response.ok) {
      throw new Error(`API请求失败，状态码: ${response.status}`);
    }
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('获取文章列表失败:', error);
    throw error;
  }
}

// 使用示例
fetchArticles()
  .then(result => {
    console.log('获取到的文章数据:', result);
    // 处理数据
  })
  .catch(error => {
    console.error('数据获取失败:', error);
  });
```

### 6.2 管理员API调用示例
```javascript
// 登录获取Token
async function login() {
  const response = await fetch('http://localhost:3000/api/v1/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      username: 'admin',
      password: 'admin123'
    })
  });
  
  const result = await response.json();
  return result.data.token;
}

// 获取管理员数据
async function fetchAdminArticles() {
  const token = await login();
  
  const response = await fetch('http://localhost:3000/api/v1/admin/articles', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    }
  });
  
  const result = await response.json();
  return result;
}
```

## 7. 数据同步机制

### 7.1 前端同步
- 文章详情页：用户浏览或点赞时，实时调用`/api/v1/articles/sync`接口
- 数据保存：同步后的数据会保存到localStorage和数据库

### 7.2 后端同步
- 数据库更新：接收同步请求后，更新数据库中的文章数据
- 事件记录：保存所有同步事件到`sync_events`表

### 7.3 管理后台同步
- 定期刷新：每30秒自动从API获取最新数据
- 手动刷新：提供刷新按钮，允许管理员手动更新数据

## 8. 故障处理和容错机制

### 8.1 API请求失败
- 重试机制：请求失败后自动重试2次
- 降级策略：API不可用时，使用localStorage或静态文件数据

### 8.2 数据不一致
- 数据合并：优先使用最新的数据，保留本地设置的属性
- 版本控制：通过版本号确保数据的一致性

### 8.3 数据库故障
- 备份恢复：定期备份数据库，故障时可恢复
- 日志记录：所有操作都有日志记录，便于排查问题

## 9. 最佳实践

1. **定期备份**：定期备份数据库和重要数据文件
2. **监控日志**：实时监控API服务日志，及时发现问题
3. **性能优化**：优化API查询，提高响应速度
4. **安全措施**：
   - 使用HTTPS协议
   - 定期更换JWT密钥
   - 限制API请求频率
   - 验证所有输入数据
5. **文档更新**：及时更新API文档，确保与实际实现一致

## 10. 总结

本方案提供了完整的线上数据获取流程，包括环境准备、API调用、权限验证、数据校验等方面。通过遵循本方案，可以确保获取到的线上数据真实、准确、完整，并能在各种情况下保证系统的正常运行。

在实际应用中，建议根据具体需求调整数据获取策略，并定期检查和优化API服务，以确保数据获取的可靠性和效率。