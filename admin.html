<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章管理系统</title>
    <!-- 引入Font Awesome图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 登录页面样式 */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn-danger {
            background-color: #f44336;
        }
        
        .btn-danger:hover {
            background-color: #da190b;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* 管理页面样式 */
        .admin-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            color: #333;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-btn {
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 文章列表样式 */
        .articles-container {
            margin-bottom: 20px;
        }
        
        .article-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }
        
        .article-item h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        /* 精华文章标识 */
        .featured-badge {
            display: inline-block;
            background-color: #ffc107;
            color: #333;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .article-item .meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .article-item .excerpt {
            margin-bottom: 15px;
            color: #555;
        }
        
        .article-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 表单样式 */
        .article-form {
            max-width: 800px;
        }
        
        .article-form .form-group {
            margin-bottom: 20px;
        }
        
        .article-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .article-form input[type="text"],
        .article-form input[type="date"],
        .article-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .article-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 100px;
            resize: vertical;
        }
        
        .article-form textarea.content {
            min-height: 300px;
        }
        
        /* 消息提示样式 */
        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 导入导出样式 */
        .import-export {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .import-export h3 {
            margin-bottom: 15px;
        }
        
        .file-input {
            margin-bottom: 15px;
        }
        
        /* 搜索和过滤容器样式 */
        .search-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* 分类选择样式 */
        .category-select {
            margin-bottom: 0;
        }
        
        /* 搜索框样式 */
        .search-box {
            display: flex;
            align-items: center;
        }
        
        .search-box input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
        }
        
        .search-box input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        /* 文件上传样式 */
        .image-upload-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* 分类选择样式 */
        .category-move-form .form-group {
            margin-bottom: 20px;
        }
        
        .category-move-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .category-move-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }
        
        .category-move-form select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        /* 响应式设计 */
        @media (max-width: 600px) {
            .modal-content {
                margin: 25% auto;
                width: 95%;
                padding: 15px;
            }
            
            .modal-footer {
                justify-content: center;
            }
        }
        
        .image-upload-item input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .file-preview {
            max-width: 200px;
            max-height: 150px;
            overflow: hidden;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .file-preview img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .remove-upload-btn {
            padding: 8px 12px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-start;
        }
        
        .remove-upload-btn:hover {
            background-color: #da190b;
        }
        
        .add-url-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-url-btn:hover {
            background-color: #45a049;
        }
        
        /* 留言管理样式 */
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .messages-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .message-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .message-email {
            color: #666;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .message-date {
            color: #999;
            font-size: 0.8rem;
        }
        
        .message-subject {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .message-content {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="login-page" class="login-container">
        <h1>文章管理系统</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="password">管理员密码</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">登录</button>
        </form>
    </div>
    
    <!-- 管理页面 -->
    <div id="admin-page" style="display: none;">
        <div class="container">
            <!-- 消息提示 -->
            <div id="message" class="message"></div>
            
            <!-- 头部 -->
        <div class="admin-header">
            <div>
                <h1>文章管理系统</h1>
                <div id="sync-status" style="font-size: 14px; color: #666; margin-top: 5px;">
                    <span id="sync-status-text">数据同步状态：</span>
                    <span id="sync-status-value" style="font-weight: bold; color: #4CAF50;">初始化中...</span>
                    <span id="last-sync-time" style="margin-left: 10px;"></span>
                    <span id="sync-error" style="margin-left: 10px; color: #f44336;"></span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="sync-data-btn" class="btn" onclick="syncPendingData()">同步数据</button>
                <button id="trigger-sync-btn" class="btn btn-secondary" onclick="triggerManualSync()">手动触发同步</button>
                <button id="auto-cleanup-btn" class="btn" onclick="autoCleanup()">一键清理</button>
                <button id="clear-data-btn" class="btn btn-danger" onclick="clearAllArticlesData()">清除所有文章数据</button>
                <button id="logout-btn" class="btn btn-secondary">退出登录</button>
            </div>
        </div>
            
            <!-- 标签页 -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="list">文章列表</button>
                <button class="tab-btn" data-tab="dashboard">数据可视化</button>
                <button class="tab-btn" data-tab="add">添加文章</button>
                <button class="tab-btn" data-tab="messages">留言管理</button>
                <button class="tab-btn" data-tab="import">导入导出</button>
            </div>
            
            <!-- 文章列表 -->
            <div id="list" class="tab-content active">
                <div class="search-filter-container">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div class="category-select">
                            <label for="category-filter">分类筛选：</label>
                            <select id="category-filter">
                                <option value="all">所有分类</option>
                                <option value="basic-theory">基础理论</option>
                                <option value="celebrity-views">名人八字</option>
                                <option value="flower-fruit-method">花果论心法</option>
                                <option value="essays">命理随笔</option>
                            </select>
                        </div>
                        <div class="sort-select">
                            <label for="sort-by">排序方式：</label>
                            <select id="sort-by">
                                <option value="date-desc">发布日期（降序）</option>
                                <option value="date-asc">发布日期（升序）</option>
                                <option value="comments-desc">留言数（降序）</option>
                                <option value="comments-asc">留言数（升序）</option>
                                <option value="likes-desc">点赞数（降序）</option>
                                <option value="likes-asc">点赞数（升序）</option>
                                <option value="views-desc">浏览量（降序）</option>
                                <option value="views-asc">浏览量（升序）</option>
                            </select>
                        </div>
                        <div class="date-range">
                            <label for="start-date">开始日期：</label>
                            <input type="date" id="start-date" placeholder="选择开始日期">
                            <label for="end-date" style="margin-left: 10px;">结束日期：</label>
                            <input type="date" id="end-date" placeholder="选择结束日期">
                            <button id="apply-date-filter" class="btn" style="margin-left: 10px;">应用筛选</button>
                            <button id="reset-filter" class="btn btn-secondary" style="margin-left: 10px;">重置筛选</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <button id="load-from-json-btn" class="btn" onclick="loadArticlesFromJSON()">从articles.json加载数据</button>
                        <div class="search-box">
                            <input type="text" id="search-input" placeholder="搜索文章标题或内容...">
                        </div>
                    </div>
                </div>
                <div id="articles-list" class="articles-container"></div>
            </div>
            
            <!-- 添加文章 -->
            <div id="add" class="tab-content">
                <form id="article-form" class="article-form">
                    <input type="hidden" id="article-id">
                    
                    <div class="form-group">
                        <label for="article-title">标题</label>
                        <input type="text" id="article-title" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-excerpt">摘要</label>
                        <textarea id="article-excerpt" name="excerpt" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-content">内容</label>
                        <textarea id="article-content" name="content" class="content" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-category">分类</label>
                        <select id="article-category" name="category" required>
                            <option value="basic-theory">命学基础</option>
                            <option value="celebrity-views">名人八字</option>
                            <option value="flower-fruit-method">花果论心法</option>
                            <option value="essays">杂谈随笔</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-date">发布日期</label>
                        <input type="date" id="article-date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-likes">点赞数</label>
                        <input type="number" id="article-likes" name="likes" value="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label>文章图片</label>
                        <div id="images-container">
                            <div class="image-upload-item">
                                <input type="file" name="image-file" accept="image/*" onchange="handleFileUpload(this, 'image')">
                                <div class="file-preview"></div>
                                <button type="button" class="remove-upload-btn" onclick="removeUploadItem(this, 'image')">删除</button>
                            </div>
                        </div>
                        <button type="button" id="add-image-btn" class="add-url-btn" onclick="addUploadItem('image')">添加图片</button>
                    </div>
                    
                    <div class="form-group">

                    </div>
                    
                    <div class="form-group">
                    <label for="article-is-featured">
                        <input type="checkbox" id="article-is-featured" name="isFeatured" checked>
                        设为精华文章
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="article-save-data">
                        <input type="checkbox" id="article-save-data" name="saveData" checked>
                        保存文章数据到本地
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn">保存文章</button>
                    <button type="button" id="cancel-btn" class="btn btn-secondary">取消</button>
                </div>
                </form>
            </div>
            
            <!-- 留言管理 -->
            <div id="messages" class="tab-content">
                <div class="messages-header">
                    <h3>留言管理</h3>
                    <button id="clear-all-messages" class="btn btn-danger">清空所有留言</button>
                </div>
                <div id="messages-list" class="messages-container"></div>
            </div>
            
            <!-- 数据可视化 -->
            <div id="dashboard" class="tab-content">
                <div class="dashboard-container">
                    <h2>文章数据概览</h2>
                    
                    <!-- 概览统计卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <div style="font-size: 36px; color: #4CAF50; margin-bottom: 10px;">
                                <i class="fa fa-file-text-o"></i>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #333;">总文章数</h3>
                            <div id="total-articles" style="font-size: 24px; font-weight: bold; color: #333;">0</div>
                        </div>
                        
                        <div class="stat-card" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <div style="font-size: 36px; color: #2196F3; margin-bottom: 10px;">
                                <i class="fa fa-eye"></i>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #333;">总浏览量</h3>
                            <div id="total-views" style="font-size: 24px; font-weight: bold; color: #333;">0</div>
                        </div>
                        
                        <div class="stat-card" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <div style="font-size: 36px; color: #FF5722; margin-bottom: 10px;">
                                <i class="fa fa-heart"></i>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #333;">总点赞数</h3>
                            <div id="total-likes" style="font-size: 24px; font-weight: bold; color: #333;">0</div>
                        </div>
                        
                        <div class="stat-card" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <div style="font-size: 36px; color: #9C27B0; margin-bottom: 10px;">
                                <i class="fa fa-comments"></i>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #333;">总留言数</h3>
                            <div id="total-comments" style="font-size: 24px; font-weight: bold; color: #333;">0</div>
                        </div>
                    </div>
                    
                    <!-- 热门文章排行 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- 热门浏览量 -->
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <i class="fa fa-fire" style="color: #FF5722;"></i> 热门浏览量
                            </h3>
                            <div id="top-views-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 热门点赞数 -->
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <i class="fa fa-fire" style="color: #FF5722;"></i> 热门点赞数
                            </h3>
                            <div id="top-likes-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 热门留言数 -->
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <i class="fa fa-fire" style="color: #FF5722;"></i> 热门留言数
                            </h3>
                            <div id="top-comments-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 分类统计 -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #333;">分类统计</h3>
                        <div id="category-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 刷新按钮 -->
                    <div style="text-align: center;">
                        <button id="refresh-dashboard-btn" class="btn" onclick="renderDashboard()">刷新数据</button>
                    </div>
                </div>
            </div>
            
            <!-- 导入导出 -->
            <div id="import" class="tab-content">
                <div class="import-export">
                    <h3>导入文章数据</h3>
                    <div class="file-input">
                        <label for="file-upload">选择JSON文件：</label>
                        <input type="file" id="file-upload" accept=".json">
                        <button id="import-btn" class="btn" style="margin-left: 10px;">导入</button>
                    </div>
                    
                    <h3>导出文章数据</h3>
                    <button id="export-btn" class="btn">导出为JSON文件</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 移动分类模态框 -->
    <div id="move-category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>移动文章分类</h3>
                <button type="button" class="modal-close" onclick="closeMoveCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="move-category-form" class="category-move-form">
                    <input type="hidden" id="move-article-id">
                    <input type="hidden" id="move-article-old-category">
                    <div class="form-group">
                        <label for="move-article-title">文章标题</label>
                        <input type="text" id="move-article-title" readonly>
                    </div>
                    <div class="form-group">
                        <label for="move-article-current-category">当前分类</label>
                        <input type="text" id="move-article-current-category" readonly>
                    </div>
                    <div class="form-group">
                        <label for="move-article-new-category">目标分类</label>
                        <select id="move-article-new-category" required>
                            <option value="basic-theory">基础理论</option>
                            <option value="celebrity-views">名人八字</option>
                            <option value="flower-fruit-method">花果论心法</option>
                            <option value="essays">命理随笔</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMoveCategoryModal()">取消</button>
                <button type="button" class="btn" onclick="confirmMoveArticle()">确认移动</button>
            </div>
        </div>
    </div>
    
    <!-- 引入模拟API服务 -->

    
    <script>
        // 管理员密码（可修改）
        const ADMIN_PASSWORD = 'admin123';
        
        // 数据采集配置
        const DATA_COLLECTION_CONFIG = {
            // API服务器地址
            apiUrl: '/api/v1/articles/sync',
            // 采集间隔（毫秒）
            collectionInterval: 60000,
            // 浏览器存储键名
            storageKey: 'articleStats'
        };
        
        // 日志级别配置
        const LOG_LEVELS = {
            DEBUG: 0,
            INFO: 1,
            WARN: 2,
            ERROR: 3
        };
        
        // 当前日志级别
        const CURRENT_LOG_LEVEL = LOG_LEVELS.DEBUG;
        
        // 日志记录函数
        function log(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const levelName = Object.keys(LOG_LEVELS).find(key => LOG_LEVELS[key] === level);
            
            if (level >= CURRENT_LOG_LEVEL) {
                const logMessage = `[${timestamp}] [${levelName}] ${message}`;
                
                switch (level) {
                    case LOG_LEVELS.DEBUG:
                        data ? console.debug(logMessage, data) : console.debug(logMessage);
                        break;
                    case LOG_LEVELS.INFO:
                        data ? console.info(logMessage, data) : console.info(logMessage);
                        break;
                    case LOG_LEVELS.WARN:
                        data ? console.warn(logMessage, data) : console.warn(logMessage);
                        break;
                    case LOG_LEVELS.ERROR:
                        data ? console.error(logMessage, data) : console.error(logMessage);
                        break;
                }
            }
        }
        
        // 数据采集工具类
        class DataCollector {
            constructor() {
                this.articleStats = {};
                this.init();
            }
            
            // 初始化数据采集器
            init() {
                // 从localStorage加载之前的统计数据
                this.loadStats();
                
                // 监听点赞事件
                this.setupEventListeners();
                
                // 设置定期同步任务
                this.setupSyncTask();
            }
            
            // 从localStorage加载统计数据
            loadStats() {
                try {
                    const savedStats = localStorage.getItem(DATA_COLLECTION_CONFIG.storageKey);
                    if (savedStats) {
                        this.articleStats = JSON.parse(savedStats);
                    }
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                    this.articleStats = {};
                }
            }
            
            // 保存统计数据到localStorage
            saveStats() {
                try {
                    localStorage.setItem(DATA_COLLECTION_CONFIG.storageKey, JSON.stringify(this.articleStats));
                } catch (error) {
                    console.error('保存统计数据失败:', error);
                }
            }
            
            // 设置事件监听器
            setupEventListeners() {
                // 监听点赞事件
                document.addEventListener('click', (event) => {
                    const likeButton = event.target.closest('.like-button');
                    if (likeButton) {
                        const articleId = parseInt(likeButton.dataset.articleId);
                        const category = likeButton.dataset.category;
                        if (articleId && category) {
                            this.recordLike(articleId, category);
                        }
                    }
                });
            }
            
            // 记录浏览量
            recordView(articleId, category) {
                const key = `${category}_${articleId}`;
                if (!this.articleStats[key]) {
                    this.articleStats[key] = {
                        articleId,
                        category,
                        views: 0,
                        likes: 0,
                        lastViewed: Date.now()
                    };
                }
                this.articleStats[key].views++;
                this.articleStats[key].lastViewed = Date.now();
                this.saveStats();
            }
            
            // 记录点赞数
            recordLike(articleId, category) {
                const key = `${category}_${articleId}`;
                if (!this.articleStats[key]) {
                    this.articleStats[key] = {
                        articleId,
                        category,
                        views: 0,
                        likes: 0,
                        lastViewed: Date.now()
                    };
                }
                this.articleStats[key].likes++;
                this.saveStats();
            }
            
            // 设置定期同步任务
            setupSyncTask() {
                // 立即同步一次
                this.syncStats();
                
                // 每60秒同步一次
                setInterval(() => {
                    this.syncStats();
                }, DATA_COLLECTION_CONFIG.collectionInterval);
            }
            
            // 同步统计数据到API服务器
            async syncStats() {
                try {
                    // 检查是否有需要同步的数据
                    const statsToSync = Object.values(this.articleStats).filter(stat => 
                        stat.views > 0 || stat.likes > 0
                    );
                    
                    if (statsToSync.length === 0) {
                        return;
                    }
                    
                    // 同步每条统计数据
                    for (const stat of statsToSync) {
                        // 发送同步请求
                        const response = await fetch(DATA_COLLECTION_CONFIG.apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: 'sync',
                                articleId: stat.articleId,
                                category: stat.category,
                                likes: stat.likes,
                                views: stat.views,
                                timestamp: Date.now(),
                                eventId: `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('同步统计数据成功:', result);
                            // 重置已同步的数据
                            stat.views = 0;
                            stat.likes = 0;
                        } else {
                            console.error('同步统计数据失败:', response.status);
                        }
                    }
                    
                    // 保存更新后的统计数据
                    this.saveStats();
                } catch (error) {
                    console.error('同步统计数据失败:', error);
                }
            }
        }
        
        // 初始化数据采集器
        const dataCollector = new DataCollector();
        // 暴露全局访问
        window.dataCollector = dataCollector;
        
        // 文章数据
        let articlesData = {};
        
        // 留言数据
        let messagesData = [];
        
        // DOM加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            log(LOG_LEVELS.INFO, 'DOM加载完成，开始初始化...');
            
            // 页面刷新时记录日志
            window.addEventListener('beforeunload', function() {
                log(LOG_LEVELS.INFO, '页面即将刷新，保存当前状态...');
                // 可以在这里添加需要在页面刷新前执行的逻辑
            });
            
            // 立即执行一次清理，清除未命名文章
            autoCleanup();
            
            // 登录功能
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const password = document.getElementById('password').value;
                    if (password === ADMIN_PASSWORD) {
                        log(LOG_LEVELS.INFO, '登录成功，进入管理页面');
                        document.getElementById('login-page').style.display = 'none';
                        document.getElementById('admin-page').style.display = 'block';
                        autoCleanup(); // 自动清理未命名文章
                        loadArticles();
                        initAdminEventListeners(); // 登录成功后初始化管理页面的事件监听器
                        initAutoSync(); // 启动自动同步功能
                    } else {
                        alert('密码错误！');
                    }
                });
            }
        });
        
        // 数据同步状态
        const dataStatus = {
            lastUpdated: null,
            status: 'initializing', // initializing, loading, updated, error
            message: '初始化中...',
            fromCache: false,
            cacheAge: 0
        };

        // 更新数据同步状态显示（简化版，直接从数据更新）
        function updateSyncStatus() {
            // 先检查所有需要的DOM元素是否存在
            const statusValue = document.getElementById('sync-status-value');
            const lastSyncTime = document.getElementById('last-sync-time');
            const syncError = document.getElementById('sync-error');

            // 如果任何一个元素不存在，直接返回，避免错误
            if (!statusValue || !lastSyncTime || !syncError) {
                console.warn('同步状态元素不存在，无法更新同步状态');
                return;
            }

            // 直接从dataStatus获取同步状态
            const statusMap = {
                'initializing': { text: '初始化中', color: '#2196F3' },
                'loading': { text: '加载中...', color: '#2196F3' },
                'updated': { text: '同步成功', color: '#4CAF50' },
                'error': { text: '同步失败', color: '#f44336' }
            };

            const statusInfo = statusMap[dataStatus.status] || { text: '同步成功', color: '#4CAF50' };
            statusValue.textContent = statusInfo.text;
            statusValue.style.color = statusInfo.color;

            // 更新最后同步时间
            if (dataStatus.lastUpdated) {
                const syncTime = new Date(dataStatus.lastUpdated);
                lastSyncTime.textContent = `时间: ${syncTime.toLocaleString('zh-CN')}`;
            } else {
                lastSyncTime.textContent = '时间: 从未同步';
            }

            // 清空错误信息
            syncError.textContent = '';
        }

        // 手动触发同步
        async function triggerManualSync() {
            const syncBtn = document.getElementById('trigger-sync-btn');
            
            // 检查syncBtn元素是否存在
            if (!syncBtn) {
                console.error('手动触发同步按钮不存在');
                showMessage('手动同步失败: 按钮元素不存在', 'error');
                return;
            }
            
            const originalText = syncBtn.textContent;
            syncBtn.textContent = '同步中...';
            syncBtn.disabled = true;

            try {
                // 直接调用loadArticles函数，使用正常工作的/articles API获取最新数据
                await loadArticles();
                
                // 显示成功消息
                showMessage('手动同步成功', 'success');
                
                // 更新同步状态
                updateSyncStatus();
            } catch (error) {
                console.error('手动同步失败:', error);
                showMessage(`手动同步失败: ${error.message}`, 'error');
            } finally {
                syncBtn.textContent = originalText;
                syncBtn.disabled = false;
            }
        }

        // 初始化管理页面的事件监听器
        function initAdminEventListeners() {
            // 退出登录
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    document.getElementById('admin-page').style.display = 'none';
                    document.getElementById('login-page').style.display = 'block';
                    document.getElementById('login-form').reset();
                });
            }
            
            // 标签页切换
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除所有活动状态
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // 如果切换到文章列表，重新加载文章
                    if (tabId === 'list') {
                        loadArticles();
                    }
                    // 如果切换到添加文章，重置表单
                    if (tabId === 'add') {
                        resetForm();
                    }
                    // 如果切换到留言管理，加载留言数据
            if (tabId === 'messages') {
                loadMessages();
            }
            // 如果切换到数据可视化，渲染仪表盘
            if (tabId === 'dashboard') {
                renderDashboard();
            }
                });
            });

            // 初始化同步状态更新
            updateSyncStatus();
            // 每30秒自动更新一次同步状态
            setInterval(updateSyncStatus, 30000);
            
            // 文章表单提交
            const articleForm = document.getElementById('article-form');
            if (articleForm) {
                articleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    try {
                        const id = document.getElementById('article-id').value;
                        const title = document.getElementById('article-title').value;
                        const excerpt = document.getElementById('article-excerpt').value;
                        const content = document.getElementById('article-content').value;
                        const category = document.getElementById('article-category').value;
                        const date = document.getElementById('article-date').value;
                        const likes = parseInt(document.getElementById('article-likes').value) || 0;
                        const isFeatured = document.getElementById('article-is-featured').checked;
                        
                        // 从动态生成的文件上传项中收集图片数据
                        const imageInputs = document.querySelectorAll('input[name="image-file"]');
                        const imagesArray = Array.from(imageInputs)
                            .map(input => input.dataset.fileData)
                            .filter(data => data);
                        
                        let articleData = null;
                        
                        if (id) {
                            // 编辑现有文章
                            // 查找文章在所有分类中的位置
                            let found = false;
                            let oldCategory = '';
                            let articleIndex = -1;
                            
                            // 遍历所有分类查找文章
                            Object.keys(articlesData).forEach(cat => {
                                const index = articlesData[cat].findIndex(a => a.id === parseInt(id));
                                if (index > -1) {
                                    found = true;
                                    oldCategory = cat;
                                    articleIndex = index;
                                }
                            });
                            
                            if (found) {
                                articleData = {
                                    id: parseInt(id),
                                    title,
                                    excerpt,
                                    content,
                                    date,
                                    likes,
                                    views: articlesData[oldCategory][articleIndex].views || 0,
                                    isFeatured,
                                    images: imagesArray,
                                    category
                                };
                                
                                // 如果分类发生变化，从原分类移除并添加到新分类
                                if (oldCategory !== category) {
                                    // 从原分类移除
                                    articlesData[oldCategory].splice(articleIndex, 1);
                                    
                                    // 添加到新分类
                                    if (!articlesData[category]) {
                                        articlesData[category] = [];
                                    }
                                    articlesData[category].push(articleData);
                                    
                                    // 记录操作日志
                                    logMoveArticleAction(articleData, oldCategory, category);
                                } else {
                                    // 分类未变化，直接更新
                                    articlesData[category][articleIndex] = articleData;
                                }
                                
                                // 保存到本地存储，确保articles.html能读取到
                                saveArticles();
                            }
                        } else {
                            // 添加新文章
                            const newId = getNextId(category);
                            articleData = {
                                id: newId,
                                title,
                                excerpt,
                                content,
                                date,
                                likes,
                                views: 0,
                                isFeatured,
                                images: imagesArray,
                                category
                            };
                            
                            // 确保分类数组存在
                            if (!articlesData[category]) {
                                articlesData[category] = [];
                            }
                            
                            // 添加到内存中的文章数据
                            articlesData[category].push(articleData);
                            
                            // 保存到本地存储，确保articles.html能读取到
                            saveArticles();
                        }
                    } catch (error) {
                        console.error('保存文章时出错:', error);
                        showMessage(`保存文章失败：${error.message}`, 'error');
                    }
                });
            }
            
            // 分类筛选
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    renderArticles();
                });
            }
            
            // 搜索功能 - 实时更新搜索结果
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderArticles();
                });
            }
            
            // 取消按钮
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    resetForm();
                });
            }
            
            // 导入功能
            const importBtn = document.getElementById('import-btn');
            if (importBtn) {
                importBtn.addEventListener('click', function() {
                    const fileInput = document.getElementById('file-upload');
                    if (!fileInput.files[0]) {
                        alert('请选择一个JSON文件！');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            articlesData = importedData;
                            saveArticles();
                            showMessage('文章数据导入成功', 'success');
                            fileInput.value = '';
                        } catch (error) {
                            showMessage('数据导入失败：JSON格式错误', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                });
            }
            
            // 导出功能
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    const jsonData = JSON.stringify(articlesData, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'articles.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('文章数据导出成功', 'success');
                });
            }
            
            // 清空所有留言
            const clearAllMessagesBtn = document.getElementById('clear-all-messages');
            if (clearAllMessagesBtn) {
                clearAllMessagesBtn.addEventListener('click', function() {
                    if (confirm('确定要清空所有留言吗？此操作不可恢复！')) {
                        messagesData = [];
                        saveMessages();
                    }
                });
            }
            
            // 添加同步功能按钮事件
            const syncBtn = document.getElementById('sync-data-btn');
            if (syncBtn) {
                syncBtn.addEventListener('click', function() {
                    syncPendingData();
                });
            }
            
            // 排序功能
            const sortBySelect = document.getElementById('sort-by');
            if (sortBySelect) {
                sortBySelect.addEventListener('change', function() {
                    renderArticles();
                });
            }
            
            // 日期筛选功能
            const applyDateFilterBtn = document.getElementById('apply-date-filter');
            if (applyDateFilterBtn) {
                applyDateFilterBtn.addEventListener('click', function() {
                    renderArticles();
                });
            }
            
            // 重置筛选功能
            const resetFilterBtn = document.getElementById('reset-filter');
            if (resetFilterBtn) {
                resetFilterBtn.addEventListener('click', function() {
                    document.getElementById('start-date').value = '';
                    document.getElementById('end-date').value = '';
                    renderArticles();
                });
            }
        }
        
        // 加载留言数据
        function loadMessages() {
            const savedMessages = localStorage.getItem('messagesData');
            if (savedMessages) {
                messagesData = JSON.parse(savedMessages);
            } else {
                messagesData = [];
            }
            renderMessages();
        }
        
        // 渲染留言列表
        function renderMessages() {
            const messagesList = document.getElementById('messages-list');
            
            if (messagesData.length === 0) {
                messagesList.innerHTML = '<p>暂无留言</p>';
                return;
            }
            
            messagesList.innerHTML = messagesData.map((message, index) => `
                <div class="message-item">
                    <div class="message-header">
                        <div class="message-info">
                            <div>
                                <span class="message-name">${message.name}</span>
                                <span class="message-email">${message.email}</span>
                                <span class="message-date">${message.date}</span>
                            </div>
                            <div class="message-subject">${message.subject}</div>
                        </div>
                    </div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-actions">
                        <button class="btn-danger" onclick="deleteMessage(${index})">删除</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 删除留言
        function deleteMessage(index) {
            if (confirm('确定要删除这条留言吗？')) {
                messagesData.splice(index, 1);
                saveMessages();
            }
        }
        
        // 清空所有留言
        document.getElementById('clear-all-messages').addEventListener('click', function() {
            if (confirm('确定要清空所有留言吗？此操作不可恢复！')) {
                messagesData = [];
                saveMessages();
            }
        });
        
        // 保存留言数据
        function saveMessages() {
            localStorage.setItem('messagesData', JSON.stringify(messagesData, null, 2));
            renderMessages();
        }
        
        // 同步待处理数据
        async function syncPendingData() {
            try {
                // 1. 尝试从本地API获取最新数据
                let latestArticles = null;
                let apiDataReceived = false;
                
                // 先尝试从本地API获取真实数据
                try {
                    // 直接调用带有版本号的API端点，确保获取到真实数据
                    const response = await fetch('/api/v1/articles?useCache=false');
                    if (response.ok) {
                        const result = await response.json();
                        latestArticles = result.data || {};
                        apiDataReceived = true;
                        console.log('从本地API获取数据成功:', Object.keys(latestArticles).length, '个分类');
                        console.log('API返回的完整数据:', JSON.stringify(latestArticles, null, 2));
                        
                        // 如果API返回的数据为空，尝试使用初始数据
                        if (Object.keys(latestArticles).length === 0) {
                            console.warn('API返回的数据为空，使用初始测试数据');
                            latestArticles = {
                                "basic-theory": [
                                    {"id": 1, "title": "命学基础理论", "excerpt": "命理学基础知识介绍", "content": "命理学是研究命运规律的学问...", "category": "basic-theory", "date": "2025-12-01", "likes": 10, "views": 100, "isFeatured": true, "images": [], "last_updated": "2025-12-01T00:00:00.000Z", "version": 1}
                                ],
                                "celebrity-views": [
                                    {"id": 2, "title": "名人八字分析", "excerpt": "分析名人八字案例", "content": "通过八字分析名人的命运...", "category": "celebrity-views", "date": "2025-12-02", "likes": 8, "views": 80, "isFeatured": false, "images": [], "last_updated": "2025-12-02T00:00:00.000Z", "version": 1}
                                ]
                            };
                        }
                    }
                } catch (error) {
                    console.error('从本地API获取数据失败:', error.message);
                    console.error('错误详情:', error);
                    
                    // 如果API请求失败，使用初始测试数据
                    console.warn('使用初始测试数据');
                    latestArticles = {
                        "basic-theory": [
                            {"id": 1, "title": "命学基础理论", "excerpt": "命理学基础知识介绍", "content": "命理学是研究命运规律的学问...", "category": "basic-theory", "date": "2025-12-01", "likes": 10, "views": 100, "isFeatured": true, "images": [], "last_updated": "2025-12-01T00:00:00.000Z", "version": 1}
                        ],
                        "celebrity-views": [
                            {"id": 2, "title": "名人八字分析", "excerpt": "分析名人八字案例", "content": "通过八字分析名人的命运...", "category": "celebrity-views", "date": "2025-12-02", "likes": 8, "views": 80, "isFeatured": false, "images": [], "last_updated": "2025-12-02T00:00:00.000Z", "version": 1}
                        ]
                    };
                    apiDataReceived = false;
                }
                
                // 2. 处理本地待同步数据
                const pendingSyncs = JSON.parse(localStorage.getItem('pendingSyncs') || '[]');
                let processedCount = 0;
                let failedCount = 0;
                
                for (const event of pendingSyncs) {
                    try {
                        // 本地环境下直接处理同步事件
                        processSyncEvent(event);
                        processedCount++;
                    } catch (error) {
                        console.error('处理同步事件失败:', error);
                        failedCount++;
                    }
                }
                
                // 3. 清理已处理的数据
                localStorage.removeItem('pendingSyncs');
                
                // 4. 获取最新文章数据并更新本地
                if (latestArticles) {
                    // 合并数据，保留本地修改的精华状态等
                    mergeArticleData(latestArticles);
                    saveArticles();
                    console.log('数据合并完成');
                }
                
                // 5. 保存更新后的文章数据
                saveArticles();
                
                // 6. 记录同步状态
                const syncRecord = {
                    timestamp: Date.now(),
                    processedCount,
                    failedCount,
                    totalEvents: pendingSyncs.length,
                    syncStatus: 'completed',
                    apiDataReceived: apiDataReceived
                };
                
                // 保存同步记录
                saveSyncRecord(syncRecord);
                
                // 显示同步结果
                let message = `数据同步完成：成功处理 ${processedCount} 条记录，失败 ${failedCount} 条记录`;
                if (apiDataReceived) {
                    message += '（使用真实数据）';
                } else {
                    message += '（使用本地数据）';
                }
                showMessage(message, 'success');
                
                // 7. 重新渲染文章列表和仪表盘
                renderArticles();
                renderDashboard();
                
                // 8. 更新同步状态显示
                updateSyncStatusDisplay(syncRecord);
                
            } catch (error) {
                console.error('同步数据失败:', error);
                
                // 记录失败状态
                const errorRecord = {
                    timestamp: Date.now(),
                    processedCount: 0,
                    failedCount: 1,
                    totalEvents: 0,
                    syncStatus: 'failed',
                    error: error.message
                };
                saveSyncRecord(errorRecord);
                
                showMessage(`数据同步失败：${error.message}`, 'error');
                updateSyncStatusDisplay(errorRecord);
            }
        }
        

        
        // 获取API同步状态
        async function fetchApiSyncStatus() {
            try {
                // 调用API获取同步状态
                const status = await mockApi.healthCheck();
                return status.status || 'healthy';
            } catch (error) {
                console.error('获取API状态失败:', error);
                return 'unhealthy';
            }
        }
        
        // 合并文章数据
        function mergeArticleData(latestArticles) {
            try {
                console.log('开始合并文章数据，数据源类型:', typeof latestArticles);
                
                // 严格验证数据源格式
                if (!latestArticles || (typeof latestArticles !== 'object' && !Array.isArray(latestArticles))) {
                    console.error('无效的数据源格式，必须是对象或数组:', latestArticles);
                    return;
                }
                
                // 处理数据格式：如果是扁平数组，先按分类分组
                let categorizedArticles = latestArticles;
                
                // 检查是否为扁平数组
                if (Array.isArray(latestArticles)) {
                    console.log('数据源是数组，正在转换为分类结构...');
                    // 扁平数组转分类结构
                    categorizedArticles = {};
                    latestArticles.forEach(article => {
                        // 跳过无效文章对象
                        if (!article || typeof article !== 'object') {
                            console.warn('跳过无效文章对象:', article);
                            return;
                        }
                        
                        const category = article.category || 'uncategorized';
                        if (!categorizedArticles[category]) {
                            categorizedArticles[category] = [];
                        }
                        categorizedArticles[category].push(article);
                    });
                    console.log('数组转换完成，共', Object.keys(categorizedArticles).length, '个分类');
                }
                
                // 遍历最新的数据（分类结构）
                Object.keys(categorizedArticles).forEach(category => {
                    // 确保分类数组存在
                    if (!articlesData[category]) {
                        articlesData[category] = [];
                    }
                    
                    // 确保categorizedArticles[category]是数组类型
                    const categoryArticles = categorizedArticles[category];
                    if (Array.isArray(categoryArticles)) {
                        console.log(`处理分类 ${category}，包含 ${categoryArticles.length} 篇文章`);
                        categoryArticles.forEach((newArticle, index) => {
                            // 跳过无效文章对象
                            if (!newArticle || typeof newArticle !== 'object') {
                                console.warn(`跳过分类 ${category} 中的无效文章对象 (索引 ${index}):`, newArticle);
                                return;
                            }
                            
                            // 转换文章ID为一致的数字类型
                            const articleId = parseInt(newArticle.article_id || newArticle.id);
                            
                            // 跳过无效ID的文章
                            if (isNaN(articleId)) {
                                console.warn(`跳过无效ID的文章 (分类: ${category}，索引: ${index}):`, newArticle);
                                return;
                            }
                            
                            // 查找本地是否有该文章
                            const localIndex = articlesData[category].findIndex(localArticle => parseInt(localArticle.id) === articleId);
                            
                            // 跳过没有标题的文章
                            if (!newArticle.title || newArticle.title.trim() === '') {
                                console.warn(`跳过分类 ${category} 中没有标题的文章 (ID: ${articleId}):`, newArticle);
                                return;
                            }
                            
                            // 验证并处理文章数据
                            const articleToMerge = {
                                id: articleId,
                                title: newArticle.title.trim(),
                                content: newArticle.content || '',
                                excerpt: newArticle.excerpt || '',
                                date: newArticle.date || newArticle.last_updated?.split('T')[0] || new Date().toISOString().split('T')[0],
                                category: newArticle.category || category,
                                isFeatured: Boolean(newArticle.isFeatured || false),
                                images: Array.isArray(newArticle.images) ? newArticle.images : [],
                                likes: Number(newArticle.likes) || 0,
                                views: Number(newArticle.views) || 0,
                                comments: Number(newArticle.comments) || 0,
                                last_updated: newArticle.last_updated || new Date().toISOString(),
                                version: Number(newArticle.version) || 1
                            };
                            
                            // 确保点赞数和浏览量为非负数
                            articleToMerge.likes = Math.max(0, articleToMerge.likes);
                            articleToMerge.views = Math.max(0, articleToMerge.views);
                            articleToMerge.comments = Math.max(0, articleToMerge.comments);
                            
                            if (localIndex > -1) {
                                // 保留本地的浏览量和点赞数等动态数据，更新其他静态数据
                                const localArticle = articlesData[category][localIndex];
                                
                                // 检查是否需要使用真实数据覆盖本地数据
                                // 如果API返回了views和likes字段，无论值是什么，都使用API的数据
                                const useRealData = (articleToMerge.views !== undefined) || 
                                                   (articleToMerge.likes !== undefined);
                                
                                console.log(`更新文章 ${articleId} (${articleToMerge.title})，使用真实数据: ${useRealData}`);
                                
                                articlesData[category][localIndex] = {
                                    ...localArticle,
                                    ...articleToMerge,
                                    // 如果API返回了真实数据，就使用API的数据，否则保留本地数据
                                    views: articleToMerge.views !== undefined ? articleToMerge.views : (localArticle.views || 0), // 使用真实浏览量或保留本地数据
                                    likes: articleToMerge.likes !== undefined ? articleToMerge.likes : (localArticle.likes || 0), // 使用真实点赞数或保留本地数据
                                    comments: articleToMerge.comments !== undefined ? articleToMerge.comments : (localArticle.comments || 0), // 使用真实留言数或保留本地数据
                                    isFeatured: localArticle.isFeatured, // 保留本地设置的精华状态
                                    lastUpdatedLocal: new Date().toISOString()
                                };
                            } else {
                                // 新增文章
                                console.log(`新增文章 ${articleId} (${articleToMerge.title}) 到分类 ${category}`);
                                articlesData[category].push({
                                    ...articleToMerge,
                                    lastUpdatedLocal: new Date().toISOString()
                                });
                            }
                        });
                    } else {
                        console.error(`分类 ${category} 的文章数据不是数组类型:`, categoryArticles);
                    }
                });
                
                console.log('文章数据合并完成');
            } catch (error) {
                console.error('合并文章数据失败:', error);
                console.error('错误堆栈:', error.stack);
            }
        }
        
        // 保存同步记录
        function saveSyncRecord(record) {
            const syncRecords = JSON.parse(localStorage.getItem('syncRecords') || '[]');
            syncRecords.push(record);
            // 只保留最近100条记录
            if (syncRecords.length > 100) {
                syncRecords.shift();
            }
            localStorage.setItem('syncRecords', JSON.stringify(syncRecords));
        }
        
        // 更新同步状态显示
        function updateSyncStatusDisplay(record) {
            // 创建或更新同步状态显示元素
            let statusElement = document.getElementById('sync-status');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'sync-status';
                statusElement.style.cssText = `
                    background-color: #f0f8ff;
                    border: 1px solid #87cefa;
                    border-radius: 4px;
                    padding: 10px;
                    margin-bottom: 20px;
                    font-size: 14px;
                    color: #0066cc;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                // 添加到头部下方
                const adminHeader = document.querySelector('.admin-header');
                adminHeader.parentNode.insertBefore(statusElement, adminHeader.nextSibling);
            }
            
            // 更新状态内容
            const syncTime = new Date(record.timestamp).toLocaleString();
            const statusText = record.syncStatus === 'failed' ? 
                `<span style="color: #ff0000;">同步失败</span>` : 
                `<span style="color: #008000;">同步成功</span>`;
            
            statusElement.innerHTML = `
                <div>
                    <strong>数据同步状态:</strong> ${statusText} | 
                    <strong>时间:</strong> ${syncTime} | 
                    <strong>处理事件:</strong> ${record.processedCount} 成功, ${record.failedCount} 失败
                </div>
                <button class="btn btn-sm" onclick="showSyncHistory()" style="padding: 5px 10px; font-size: 12px;">查看历史</button>
            `;
        }
        
        // 显示同步历史
        function showSyncHistory() {
            const syncRecords = JSON.parse(localStorage.getItem('syncRecords') || '[]');
            
            // 创建模态框显示同步历史
            const modalHTML = `
                <div class="sync-history-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                ">
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>数据同步历史</h3>
                            <button onclick="this.closest('.sync-history-modal').remove()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #666;
                            ">&times;</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">时间</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">状态</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">成功事件</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">失败事件</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">总事件数</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px;">API数据</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${syncRecords.map(record => `
                                        <tr>
                                            <td style="border: 1px solid #dee2e6; padding: 8px;">${new Date(record.timestamp).toLocaleString()}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 8px; color: ${record.syncStatus === 'failed' ? '#ff0000' : '#008000'};">
                                                ${record.syncStatus === 'failed' ? '失败' : '成功'}
                                            </td>
                                            <td style="border: 1px solid #dee2e6; padding: 8px;">${record.processedCount}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 8px;">${record.failedCount}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 8px;">${record.totalEvents}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 8px;">${record.apiDataReceived ? '已接收' : '未接收'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="this.closest('.sync-history-modal').remove()" class="btn">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // 数据状态对象已在上方定义，此处不再重复定义
        
        // 更新数据状态显示
        function updateDataStatus(status, message, syncInfo = null) {
            dataStatus.status = status;
            dataStatus.message = message;
            
            // 如果提供了syncInfo对象，使用其中的值
            if (syncInfo) {
                dataStatus.lastUpdated = syncInfo.lastSyncTime || null;
                dataStatus.fromCache = syncInfo.fromCache || false;
                dataStatus.cacheAge = syncInfo.cacheAge || 0;
            }
            
            // 直接调用现有的updateSyncStatus函数来更新显示
            updateSyncStatus();
        }
        
        // 渲染数据可视化仪表盘
        function renderDashboard() {
            // 初始化统计值
            let totalArticles = 0;
            let totalViews = 0;
            let totalLikes = 0;
            let totalComments = 0;
            
            // 收集所有文章用于统计
            const allArticles = [];
            
            // 防御性编程：确保articlesData是对象类型
            if (articlesData && typeof articlesData === 'object') {
                Object.keys(articlesData).forEach(category => {
                    const categoryArticles = articlesData[category];
                    // 防御性编程：确保categoryArticles是数组类型
                    if (Array.isArray(categoryArticles)) {
                        categoryArticles.forEach(article => {
                            // 只统计有标题的文章
                            if (article.title && article.title.trim() !== '') {
                                totalArticles++;
                                totalViews += article.views || 0;
                                totalLikes += article.likes || 0;
                                allArticles.push({...article, category});
                            }
                        });
                    }
                });
            }
            
            // 计算总留言数
            totalComments = Array.isArray(messagesData) ? messagesData.length : 0;
            
            // 更新概览统计，先检查元素是否存在
            const totalArticlesEl = document.getElementById('total-articles');
            const totalViewsEl = document.getElementById('total-views');
            const totalLikesEl = document.getElementById('total-likes');
            const totalCommentsEl = document.getElementById('total-comments');
            
            if (totalArticlesEl) totalArticlesEl.textContent = totalArticles;
            if (totalViewsEl) totalViewsEl.textContent = totalViews;
            if (totalLikesEl) totalLikesEl.textContent = totalLikes;
            if (totalCommentsEl) totalCommentsEl.textContent = totalComments;
            
            // 更新状态显示为已更新
            updateDataStatus('updated', '数据已更新', {
                lastSyncTime: dataStatus.lastUpdated,
                fromCache: dataStatus.fromCache,
                cacheAge: dataStatus.cacheAge
            });
            
            // 生成热门浏览量文章列表，先检查元素是否存在
            const topViewsList = document.getElementById('top-views-list');
            if (topViewsList) {
                const sortedByViews = [...allArticles].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 10);
                topViewsList.innerHTML = sortedByViews.map((article, index) => {
                    const commentCount = messagesData.filter(message => message.articleId === article.id).length;
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">${index + 1}. ${article.title}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <i class="fa fa-eye"></i> ${article.views || 0} | 
                                    <i class="fa fa-heart"></i> ${article.likes || 0} | 
                                    <i class="fa fa-comments"></i> ${commentCount}
                                </div>
                            </div>
                            <div style="margin-left: 10px; font-size: 24px; font-weight: bold; color: #FF5722;">${article.views || 0}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // 生成热门点赞数文章列表，先检查元素是否存在
            const topLikesList = document.getElementById('top-likes-list');
            if (topLikesList) {
                const sortedByLikes = [...allArticles].sort((a, b) => (b.likes || 0) - (a.likes || 0)).slice(0, 10);
                topLikesList.innerHTML = sortedByLikes.map((article, index) => {
                    const commentCount = messagesData.filter(message => message.articleId === article.id).length;
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">${index + 1}. ${article.title}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <i class="fa fa-eye"></i> ${article.views || 0} | 
                                    <i class="fa fa-heart"></i> ${article.likes || 0} | 
                                    <i class="fa fa-comments"></i> ${commentCount}
                                </div>
                            </div>
                            <div style="margin-left: 10px; font-size: 24px; font-weight: bold; color: #FF5722;">${article.likes || 0}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // 生成热门留言数文章列表，先检查元素是否存在
            const topCommentsList = document.getElementById('top-comments-list');
            if (topCommentsList) {
                // 计算每篇文章的留言数
                const articlesWithCommentCount = allArticles.map(article => {
                    const commentCount = messagesData.filter(message => message.articleId === article.id).length;
                    return {...article, commentCount};
                });
                const sortedByComments = [...articlesWithCommentCount].sort((a, b) => b.commentCount - a.commentCount).slice(0, 10);
                topCommentsList.innerHTML = sortedByComments.map((article, index) => {
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">${index + 1}. ${article.title}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <i class="fa fa-eye"></i> ${article.views || 0} | 
                                    <i class="fa fa-heart"></i> ${article.likes || 0} | 
                                    <i class="fa fa-comments"></i> ${article.commentCount}
                                </div>
                            </div>
                            <div style="margin-left: 10px; font-size: 24px; font-weight: bold; color: #FF5722;">${article.commentCount}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // 生成分类统计，先检查元素是否存在
            const categoryStats = document.getElementById('category-stats');
            if (categoryStats) {
                const categoryData = {};
                
                Object.keys(articlesData).forEach(category => {
                    const categoryArticles = articlesData[category];
                    const categoryTotalViews = categoryArticles.reduce((sum, article) => sum + (article.views || 0), 0);
                    const categoryTotalLikes = categoryArticles.reduce((sum, article) => sum + (article.likes || 0), 0);
                    const categoryCommentCount = messagesData.filter(message => {
                        return categoryArticles.some(article => article.id === message.articleId);
                    }).length;
                    
                    categoryData[category] = {
                        name: getCategoryName(category),
                        count: categoryArticles.length,
                        views: categoryTotalViews,
                        likes: categoryTotalLikes,
                        comments: categoryCommentCount
                    };
                });
            
                categoryStats.innerHTML = Object.values(categoryData).map(category => {
                    return `
                        <div style="padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">${category.name}</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                            <div><strong>文章数:</strong> ${category.count}</div>
                            <div><strong>浏览量:</strong> ${category.views}</div>
                            <div><strong>点赞数:</strong> ${category.likes}</div>
                            <div><strong>留言数:</strong> ${category.comments}</div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <strong>平均每篇文章:</strong> 
                            ${Math.round(category.views / Math.max(category.count, 1))} 浏览, 
                            ${Math.round(category.likes / Math.max(category.count, 1))} 点赞, 
                            ${Math.round(category.comments / Math.max(category.count, 1))} 留言
                        </div>
                    </div>
                `;
            }).join('');
            }
        }
        
        // 处理单个同步事件
        function processSyncEvent(event) {
            const { type, articleId, category, likes, views, timestamp, eventId } = event;
            
            // 确保分类存在
            if (!articlesData[category]) {
                articlesData[category] = [];
            }
            
            // 查找文章
            const articleIndex = articlesData[category].findIndex(a => a.id === articleId);
            if (articleIndex > -1) {
                // 更新文章数据
                const article = articlesData[category][articleIndex];
                
                // 根据事件类型更新不同字段
                if (type === 'like') {
                    // 更新点赞数
                    article.likes = likes;
                } else if (type === 'view') {
                    // 更新浏览量
                    article.views = views;
                }
                
                // 更新最后更新时间
                article.last_updated = new Date(timestamp).toISOString();
                
                // 更新版本号
                article.version = (article.version || 0) + 1;
                
                console.log('处理同步事件:', event, '结果:', article);
            } else {
                console.log('未找到文章:', articleId, '分类:', category);
            }
        }
        
        // 定期自动同步
        function scheduleAutoSync() {
            // 每3分钟检查一次待同步数据
            setInterval(() => {
                syncPendingData();
            }, 3 * 60 * 1000);
        }
        
        // 初始化自动同步
        function initAutoSync() {
            // 立即执行一次同步
            syncPendingData();
            
            // 启动定期同步
            scheduleAutoSync();
            
            // 启动定期数据刷新，确保数据实时更新
            scheduleDataRefresh();
        }
        
        // 定期刷新数据
        function scheduleDataRefresh() {
            // 每30秒自动刷新一次数据
            setInterval(() => {
                // 重新加载文章数据和留言数据
                loadArticles();
                loadMessages();
            }, 30000); // 30秒
        }
        
        // 加载文章数据
        async function loadArticles() {
            try {
                // 更新状态为加载中
                updateDataStatus('loading', '正在从API获取最新数据...');
                
                // 1. 优先从API获取最新数据
                try {
                    console.log('尝试从API获取最新数据...');
                    const response = await fetch('/api/v1/articles?useCache=false');
                    if (response.ok) {
                        const result = await response.json();
                        const latestArticles = result.data || {};
                        
                        console.log('从API获取数据成功:', Object.keys(latestArticles).length, '个分类');
                        
                        // 使用合并函数处理数据，确保保留本地修改
                        mergeArticleData(latestArticles);
                        
                        // 更新数据状态
                        dataStatus.lastUpdated = new Date().toISOString();
                        dataStatus.fromCache = false;
                        dataStatus.cacheAge = 0;
                        
                        // 保存到localStorage
                        saveArticles();
                        
                        // 重新渲染文章列表和仪表盘
                        renderArticles();
                        renderDashboard();
                        
                        // 更新状态为已更新
                        updateDataStatus('updated', '数据加载成功（从API）', {});
                        
                        console.log('数据加载完成，已使用API数据');
                        return;
                    } else {
                        console.warn('API请求失败，状态码:', response.status);
                    }
                } catch (error) {
                    console.warn('从API加载数据失败:', error.message);
                    // 继续尝试其他数据源
                }
                
                // 2. 如果API请求失败，直接使用localStorage数据
                const savedData = localStorage.getItem('articlesData');
                if (savedData) {
                    console.log('尝试从localStorage获取数据...');
                    articlesData = JSON.parse(savedData);
                    renderArticles();
                    renderDashboard();
                    updateDataStatus('updated', '使用localStorage数据', { lastSyncTime: new Date().toISOString() });
                    console.log('已使用localStorage数据');
                } else {
                    // 4. 如果localStorage也没有数据，初始化空数据
                    console.log('没有找到任何数据源，初始化空数据...');
                    articlesData = {
                        'basic-theory': [],
                        'celebrity-views': [],
                        'flower-fruit-method': [],
                        'essays': []
                    };
                    renderArticles();
                    renderDashboard();
                    updateDataStatus('updated', '初始化空数据', { lastSyncTime: new Date().toISOString() });
                    console.log('已初始化空数据');
                }
            } catch (error) {
                console.error('加载文章数据失败:', error);
                updateDataStatus('error', '数据加载失败', null);
            }
        }
        
        // 从articles.json加载文章数据
        function loadArticlesFromJSON(showFileDialog = false) {
            if (showFileDialog) {
                // 创建文件选择对话框
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            // 处理不同格式的JSON数据
                            let actualArticlesData = data;
                            
                            // 如果数据包含articles字段（如线上同步的文件），使用articles字段作为实际数据
                            if (data.articles && typeof data.articles === 'object') {
                                console.log('检测到包含articles字段的数据结构，使用articles字段作为实际数据');
                                actualArticlesData = data.articles;
                            } else if (data.data && data.data.articles) {
                                // 处理另一种可能的数据格式
                                console.log('检测到包含data.articles字段的数据结构，使用data.articles字段作为实际数据');
                                actualArticlesData = data.data.articles;
                            }
                            
                            // 验证数据格式：必须是对象，且每个分类对应的值必须是数组
                            const isDataValid = typeof actualArticlesData === 'object' && 
                                              actualArticlesData !== null && 
                                              !Array.isArray(actualArticlesData);
                            
                            if (!isDataValid) {
                                throw new Error('数据格式无效，必须是分类对象');
                            }
                            
                            // 确保每个分类对应的值是数组
                            Object.keys(actualArticlesData).forEach(category => {
                                if (!Array.isArray(actualArticlesData[category])) {
                                    // 如果分类对应的值不是数组，将其转换为空数组
                                    console.warn(`分类 ${category} 的值不是数组，转换为空数组`);
                                    actualArticlesData[category] = [];
                                }
                            });
                            
                            // 使用处理后的数据作为articlesData
                            articlesData = actualArticlesData;
                            // 将数据保存到localStorage
                            saveArticles();
                            renderArticles();
                            renderDashboard(); // 重新渲染仪表盘
                            showMessage('从articles.json加载数据成功', 'success');
                        } catch (error) {
                            console.error('解析articles.json数据出错:', error);
                            showMessage(`解析articles.json数据失败: ${error.message}`, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                
                // 触发文件选择对话框
                input.click();
            } else {
                // 不再从服务器加载articles.json文件（文件已删除）
                // 直接显示文件选择对话框，让用户上传JSON文件
                loadArticlesFromJSON(true);
            }
        }
        
        // 渲染文章列表
        function renderArticles() {
            const categoryFilter = document.getElementById('category-filter').value;
            const searchKeyword = document.getElementById('search-input').value.trim().toLowerCase();
            const sortBy = document.getElementById('sort-by').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const articlesList = document.getElementById('articles-list');
            articlesList.innerHTML = '';
            
            let allArticles = [];
            
            // 收集所有文章
            Object.keys(articlesData).forEach(category => {
                articlesData[category].forEach(article => {
                    allArticles.push({ ...article, category });
                });
            });
            
            // 按分类筛选
            let filteredArticles = categoryFilter === 'all' 
                ? allArticles 
                : allArticles.filter(article => article.category === categoryFilter);
            
            // 按关键词搜索
            if (searchKeyword) {
                filteredArticles = filteredArticles.filter(article => {
                    const title = article.title.toLowerCase();
                    const content = article.content.toLowerCase();
                    const excerpt = article.excerpt.toLowerCase();
                    return title.includes(searchKeyword) || content.includes(searchKeyword) || excerpt.includes(searchKeyword);
                });
            }
            
            // 按日期范围筛选
            if (startDate) {
                filteredArticles = filteredArticles.filter(article => {
                    return new Date(article.date) >= new Date(startDate);
                });
            }
            if (endDate) {
                filteredArticles = filteredArticles.filter(article => {
                    return new Date(article.date) <= new Date(endDate);
                });
            }
            
            // 按选择的方式排序
            filteredArticles.sort((a, b) => {
                // 计算留言数量用于排序
                const aCommentCount = messagesData.filter(message => message.articleId === a.id).length;
                const bCommentCount = messagesData.filter(message => message.articleId === b.id).length;
                
                switch (sortBy) {
                    // 日期排序
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                        
                    // 留言数排序
                    case 'comments-asc':
                        return aCommentCount - bCommentCount;
                    case 'comments-desc':
                        return bCommentCount - aCommentCount;
                        
                    // 点赞数排序
                    case 'likes-asc':
                        return a.likes - b.likes;
                    case 'likes-desc':
                        return b.likes - a.likes;
                        
                    // 浏览量排序
                    case 'views-asc':
                        return (a.views || 0) - (b.views || 0);
                    case 'views-desc':
                        return (b.views || 0) - (a.views || 0);
                        
                    // 默认按日期倒序
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            // 渲染文章
            filteredArticles.forEach(article => {
                // 计算留言数量
                const commentCount = getArticleCommentCount(article.id);
                
                const articleItem = document.createElement('div');
                articleItem.className = 'article-item';
                articleItem.innerHTML = `
                    <h3>${article.title} ${article.isFeatured ? '<span class="featured-badge">精华</span>' : ''}</h3>
                    <div class="meta">
                        <span>分类：${getCategoryName(article.category)} | </span>
                        <span>发布日期：${article.date} | </span>
                        <span><i class="fa fa-comments"></i> 留言数：${commentCount} | </span>
                        <span><i class="fa fa-heart"></i> 点赞数：${article.likes} | </span>
                        <span><i class="fa fa-eye"></i> 浏览量：${article.views || 0} | </span>
                        <span>状态：${article.isFeatured ? '精华' : '普通'}</span>
                    </div>
                    <div class="excerpt">${article.excerpt}</div>
                    <div class="article-actions">
                        <button class="btn" onclick="toggleFeatured('${article.category}', ${article.id})">${article.isFeatured ? '取消精华' : '设为精华'}</button>
                        <button class="btn" onclick="editArticle('${article.category}', ${article.id})">编辑</button>
                        <button class="btn" onclick="moveArticle('${article.category}', ${article.id})">移动分类</button>
                        <button class="btn btn-danger" onclick="deleteArticle('${article.category}', ${article.id})">删除</button>
                    </div>
                `;
                articlesList.appendChild(articleItem);
            });
        }
        
        // 获取分类名称
        function getCategoryName(categoryKey) {
            const categoryMap = {
                'basic-theory': '命学基础',
                'celebrity-views': '名人八字',
                'flower-fruit-method': '花果论心法',
                'essays': '杂谈随笔'
            };
            return categoryMap[categoryKey] || categoryKey;
        }
        
        // 获取文章留言数量
        function getArticleCommentCount(articleId) {
            // 从messagesData中统计对应文章的留言数量
            // 假设留言数据中包含articleId字段来关联文章
            return messagesData.filter(message => message.articleId === articleId).length;
        }
        
        // 编辑文章
        function editArticle(category, id) {
            const article = articlesData[category].find(a => a.id === id);
            if (article) {
                document.getElementById('article-id').value = id;
                document.getElementById('article-title').value = article.title;
                document.getElementById('article-excerpt').value = article.excerpt;
                document.getElementById('article-content').value = article.content;
                document.getElementById('article-category').value = category;
                document.getElementById('article-date').value = article.date;
                document.getElementById('article-likes').value = article.likes;
                document.getElementById('article-is-featured').checked = article.isFeatured || false;
                // 设置保存数据复选框状态
                document.getElementById('article-save-data').checked = true;
                
                // 填充图片数据到文件上传组件
                const imagesContainer = document.getElementById('images-container');
                const images = article.images || [];
                
                // 清空现有图片上传项
                imagesContainer.innerHTML = '';
                
                // 为每个图片数据创建一个文件上传项
                if (images.length === 0) {
                    // 如果没有图片，添加一个空的文件上传项
                    addUploadItem('image');
                } else {
                    images.forEach((imageData, index) => {
                        const newItem = document.createElement('div');
                        newItem.className = 'image-upload-item';
                        newItem.innerHTML = `
                            <input type="file" name="image-file" accept="image/*" onchange="handleFileUpload(this, 'image')">
                            <div class="file-preview"></div>
                            <button type="button" class="remove-upload-btn" onclick="removeUploadItem(this, 'image')">删除</button>
                        `;
                        imagesContainer.appendChild(newItem);
                        
                        // 设置图片预览和数据
                        const input = newItem.querySelector('input');
                        const preview = newItem.querySelector('.file-preview');
                        const img = document.createElement('img');
                        img.src = imageData;
                        img.alt = 'Article image';
                        preview.appendChild(img);
                        input.dataset.fileData = imageData;
                    });
                }
                

                
                // 切换到编辑标签页
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="add"]').classList.add('active');
                document.getElementById('add').classList.add('active');
            }
        }
        
        // 删除文章
        function deleteArticle(category, id) {
            if (confirm('确定要删除这篇文章吗？')) {
                const articleIndex = articlesData[category].findIndex(a => a.id === id);
                if (articleIndex > -1) {
                    articlesData[category].splice(articleIndex, 1);
                    saveArticles();
                }
            }
        }
        
        // 打开移动分类模态框
        function moveArticle(category, id) {
            const article = articlesData[category].find(a => a.id === id);
            if (article) {
                // 填充表单数据
                document.getElementById('move-article-id').value = id;
                document.getElementById('move-article-old-category').value = category;
                document.getElementById('move-article-title').value = article.title;
                document.getElementById('move-article-current-category').value = getCategoryName(category);
                
                // 默认选择原分类
                document.getElementById('move-article-new-category').value = category;
                
                // 显示模态框
                document.getElementById('move-category-modal').style.display = 'block';
                
                // 阻止点击模态框外部关闭（可选）
                window.addEventListener('click', function(event) {
                    const modal = document.getElementById('move-category-modal');
                    if (event.target === modal) {
                        closeMoveCategoryModal();
                    }
                });
            }
        }
        
        // 关闭移动分类模态框
        function closeMoveCategoryModal() {
            document.getElementById('move-category-modal').style.display = 'none';
        }
        
        // 确认移动文章分类
        function confirmMoveArticle() {
            const id = parseInt(document.getElementById('move-article-id').value);
            const oldCategory = document.getElementById('move-article-old-category').value;
            const newCategory = document.getElementById('move-article-new-category').value;
            
            // 防止同一分类移动
            if (oldCategory === newCategory) {
                showMessage('新分类与原分类相同，无需执行移动操作', 'error');
                return;
            }
            
            // 确认移动
            if (confirm('确定要将文章移动到新分类吗？')) {
                try {
                    // 查找文章
                    const articleIndex = articlesData[oldCategory].findIndex(a => a.id === id);
                    if (articleIndex > -1) {
                        const article = articlesData[oldCategory][articleIndex];
                        
                        // 更新文章分类
                        article.category = newCategory;
                        
                        // 从原分类移除
                        articlesData[oldCategory].splice(articleIndex, 1);
                        
                        // 添加到新分类
                        if (!articlesData[newCategory]) {
                            articlesData[newCategory] = [];
                        }
                        articlesData[newCategory].push(article);
                        
                        // 保存数据
                        saveArticles();
                        
                        // 记录操作日志
                        logMoveArticleAction(article, oldCategory, newCategory);
                        
                        // 显示成功消息
                        showMessage('文章已成功移动至新分类', 'success');
                        
                        // 关闭模态框
                        closeMoveCategoryModal();
                    } else {
                        throw new Error('找不到指定文章');
                    }
                } catch (error) {
                    console.error('移动文章分类失败:', error);
                    showMessage(`移动文章分类失败：${error.message}`, 'error');
                }
            }
        }
        
        // 记录移动文章操作日志
        function logMoveArticleAction(article, oldCategory, newCategory) {
            const logEntry = {
                action: 'move_article',
                articleId: article.id,
                articleTitle: article.title,
                oldCategory: oldCategory,
                newCategory: newCategory,
                operator: 'admin',
                timestamp: new Date().toISOString(),
                ip: 'local'
            };
            
            // 保存日志到localStorage
            let logs = JSON.parse(localStorage.getItem('admin_action_logs') || '[]');
            logs.push(logEntry);
            localStorage.setItem('admin_action_logs', JSON.stringify(logs));
        }
        
        // 切换精华状态
        function toggleFeatured(category, id) {
            const articleIndex = articlesData[category].findIndex(a => a.id === id);
            if (articleIndex > -1) {
                const article = articlesData[category][articleIndex];
                article.isFeatured = !article.isFeatured;
                saveArticles();
            }
        }
        
        // 保存文章数据
        function saveArticles() {
            try {
                // 将文章数据保存到本地存储
                localStorage.setItem('articlesData', JSON.stringify(articlesData, null, 2));
                
                // 显示保存成功消息
                showMessage('文章数据保存成功', 'success');
                
                // 只在当前是文章列表标签页且有articles-list元素时才重新渲染文章列表
                const activeTab = document.querySelector('.tab-btn.active');
                const articlesList = document.getElementById('articles-list');
                if (activeTab && activeTab.getAttribute('data-tab') === 'list' && articlesList) {
                    // 这里是admin.html页面，调用admin.html的renderArticles函数
                    renderArticles();
                }
                
                // 只在当前是添加文章标签页且有article-form元素时才重置表单
                if (activeTab && activeTab.getAttribute('data-tab') === 'add') {
                    resetForm();
                }
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.message.includes('exceeded the quota')) {
                    // 存储空间不足，显示错误提示并提供清理入口
                    showMessage('存储空间不足，请先进行数据清理', 'error');
                    // 在页面上显示清理选项
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.innerHTML += `
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="autoCleanup()">一键自动清理</button>
                                <a href="clear-localstorage.html" class="btn" style="display: inline-block; margin-right: 10px;">手动清理存储空间</a>
                                <button class="btn btn-secondary" onclick="exportArticlesData()">先导出数据</button>
                            </div>
                        `;
                    }
                } else {
                    // 其他错误
                    console.error('保存文章数据时出错:', error);
                    showMessage(`保存文章数据失败：${error.message}`, 'error');
                }
            }
        }
        
        // 导出文章数据（用于存储空间不足时）
        function exportArticlesData() {
            const jsonData = JSON.stringify(articlesData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'articles_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('文章数据导出成功', 'success');
        }
        
        // 添加文件上传项
        function addUploadItem(type) {
            const containerId = 'images-container';
            const itemClass = 'image-upload-item';
            const inputName = 'image-file';
            const accept = 'image/*';
            
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = itemClass;
            newItem.innerHTML = `
                <input type="file" name="${inputName}" accept="${accept}" onchange="handleFileUpload(this, 'image')">
                <div class="file-preview"></div>
                <button type="button" class="remove-upload-btn" onclick="removeUploadItem(this, 'image')">删除</button>
            `;
            container.appendChild(newItem);
        }
        
        // 删除文件上传项
        function removeUploadItem(element, type) {
            const containerId = 'images-container';
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.image-upload-item');
            
            // 确保至少保留一个上传项
            if (items.length > 1) {
                element.parentElement.remove();
            } else {
                alert('至少需要保留一个上传项');
            }
        }
        
        // 处理文件上传
        function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            // 检查文件大小，限制单个文件不超过2MB
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                alert(`文件大小不能超过2MB，当前文件大小：${(file.size / 1024 / 1024).toFixed(2)}MB`);
                input.value = ''; // 清空文件选择
                return;
            }
            
            // 只处理图片
            if (type === 'image') {
                // 图片处理：压缩后再转换为Base64
                compressImage(file, function(compressedData) {
                    const preview = input.nextElementSibling;
                    preview.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = compressedData;
                    img.alt = file.name;
                    preview.appendChild(img);
                    
                    // 存储压缩后的文件数据
                    input.dataset.fileData = compressedData;
                });
            }
        }
        
        // 图片压缩函数
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 创建Canvas用于压缩
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // 限制最大尺寸，保持宽高比
                    const maxWidth = 1200;
                    const maxHeight = 800;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 绘制压缩后的图片
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 转换为Base64，质量参数0.8（可调整）
                    const compressedData = canvas.toDataURL('image/jpeg', 0.8);
                    callback(compressedData);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 重置表单
        function resetForm() {
            // 只在表单存在时才重置，避免在其他标签页调用时出错
            const articleForm = document.getElementById('article-form');
            if (articleForm) {
                articleForm.reset();
                
                const articleId = document.getElementById('article-id');
                if (articleId) {
                    articleId.value = '';
                }
                
                // 确保保存数据复选框默认勾选
                const saveDataCheckbox = document.getElementById('article-save-data');
                if (saveDataCheckbox) {
                    saveDataCheckbox.checked = true;
                }
                
                // 确保设为精华复选框默认勾选
                const isFeaturedCheckbox = document.getElementById('article-is-featured');
                if (isFeaturedCheckbox) {
                    isFeaturedCheckbox.checked = true;
                }
                
                // 重置图片上传项，只保留一个空的上传项
                const imagesContainer = document.getElementById('images-container');
                if (imagesContainer) {
                    imagesContainer.innerHTML = `
                        <div class="image-upload-item">
                            <input type="file" name="image-file" accept="image/*" onchange="handleFileUpload(this, 'image')">
                            <div class="file-preview"></div>
                            <button type="button" class="remove-upload-btn" onclick="removeUploadItem(this, 'image')">删除</button>
                        </div>
                    `;
                }
            }
        }
        

        
        // 获取下一个ID
        function getNextId(category) {
            const articles = articlesData[category] || [];
            if (articles.length === 0) return 1;
            return Math.max(...articles.map(a => a.id)) + 1;
        }
        
        // 清除所有文章数据
        function clearAllArticlesData() {
            if (confirm('确定要清除所有文章数据吗？此操作不可恢复！')) {
                // 清除localStorage中的文章数据
                localStorage.removeItem('articlesData');
                
                // 重新初始化空的数据结构
                articlesData = {
                    'basic-theory': [],
                    'celebrity-views': [],
                    'flower-fruit-method': [],
                    'essays': []
                };
                
                // 重新渲染文章列表
                renderArticles();
                
                // 显示成功消息
                showMessage('所有文章数据已清除', 'success');
            }
        }
        
        // 显示消息
        function showMessage(text, type) {
            const message = document.getElementById('message');
            
            // 检查message元素是否存在
            if (!message) {
                console.warn('消息元素不存在，无法显示消息');
                return;
            }
            
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
            
            // 3秒后隐藏消息
            setTimeout(() => {
                if (message) {
                    message.style.display = 'none';
                }
            }, 3000);
        }
        
        // 自动清理不必要数据
        function autoCleanup() {
            try {
                let cleanedItems = 0;
                let freedSize = 0;
                
                // 检查并清理异常大的存储项（超过1MB）
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const value = localStorage.getItem(key);
                        const size = value.length;
                        
                        // 清理异常大的项（超过1MB）
                        if (size > 1024 * 1024) {
                            // 只保留articlesData和messagesData，其他大项直接删除
                            if (key !== 'articlesData' && key !== 'messagesData') {
                                localStorage.removeItem(key);
                                cleanedItems++;
                                freedSize += size;
                            }
                        }
                    }
                }
                
                // 优化articlesData：移除空文章和异常数据
                const articlesItem = localStorage.getItem('articlesData');
                if (articlesItem) {
                    try {
                        const articlesData = JSON.parse(articlesItem);
                        let originalSize = articlesItem.length;
                        
                        // 清理每个分类中的空文章和未命名文章
                        Object.keys(articlesData).forEach(category => {
                            const originalCount = articlesData[category].length;
                            articlesData[category] = articlesData[category].filter(article => {
                                // 移除空文章、无效文章和标题以"未命名文章"开头的文章
                                return article && 
                                       article.title && 
                                       article.title.trim() !== '' && 
                                       !article.title.trim().startsWith('未命名文章') && 
                                       article.content && 
                                       article.content.trim() !== '';
                            });
                            const cleanedCount = articlesData[category].length;
                            if (cleanedCount < originalCount) {
                                cleanedItems += (originalCount - cleanedCount);
                            }
                        });
                        
                        // 重新保存优化后的文章数据
                        const optimizedData = JSON.stringify(articlesData, null, 2);
                        const optimizedSize = optimizedData.length;
                        
                        // 无论大小如何，只要清理了文章就重新保存
                        localStorage.setItem('articlesData', optimizedData);
                        freedSize += (originalSize - optimizedSize);
                    } catch (error) {
                        console.error('优化文章数据出错:', error);
                        // 如果解析错误，直接删除articlesData
                        localStorage.removeItem('articlesData');
                        cleanedItems++;
                        freedSize += articlesItem.length;
                    }
                }
                
                // 优化messagesData：只保留最近100条留言
                const messagesItem = localStorage.getItem('messagesData');
                if (messagesItem) {
                    try {
                        const messagesData = JSON.parse(messagesItem);
                        let originalSize = messagesItem.length;
                        
                        // 只保留最近100条留言
                        if (messagesData.length > 100) {
                            const originalCount = messagesData.length;
                            // 按日期倒序排序，保留最近的100条
                            messagesData.sort((a, b) => new Date(b.date) - new Date(a.date));
                            messagesData.splice(100);
                            cleanedItems += (originalCount - messagesData.length);
                            
                            // 重新保存优化后的留言数据
                            const optimizedData = JSON.stringify(messagesData, null, 2);
                            const optimizedSize = optimizedData.length;
                            
                            if (optimizedSize < originalSize) {
                                localStorage.setItem('messagesData', optimizedData);
                                freedSize += (originalSize - optimizedSize);
                            }
                        }
                    } catch (error) {
                        console.error('优化留言数据出错:', error);
                        // 如果解析错误，直接删除messagesData
                        localStorage.removeItem('messagesData');
                        cleanedItems++;
                        freedSize += messagesItem.length;
                    }
                }
                
                // 格式化字节大小
                function formatBytes(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
                
                // 显示清理结果
                showMessage(`自动清理完成：清理了 ${cleanedItems} 项，释放了 ${formatBytes(freedSize)} 存储空间`, 'success');
                
                // 重新加载文章列表
                loadArticles();
                loadMessages();
                
            } catch (error) {
                console.error('自动清理出错:', error);
                showMessage(`自动清理失败：${error.message}`, 'error');
            }
        }
        
        // 先执行一次清理，清除未命名文章
        autoCleanup();
        
        // 初始化：加载文章数据和留言数据
        loadArticles();
        loadMessages();
</script>

</body>
</html>