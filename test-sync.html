<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-result {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 14px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-secondary {
            background-color: #2196F3;
        }
        .btn-secondary:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <h1>文章留言和点赞数据同步测试</h1>
    
    <div style="text-align: center;">
        <button class="btn" onclick="runTest()">运行测试</button>
        <button class="btn btn-secondary" onclick="clearResults()">清空结果</button>
    </div>
    
    <div class="test-result">
        <h2>测试结果</h2>
        <div id="test-output"></div>
    </div>
    
    <div class="test-result">
        <h2>文章数据</h2>
        <pre id="articles-data"></pre>
    </div>
    
    <script>
        // 保存控制台输出
        let testOutput = '';
        
        // 重定向console.log到页面
        const originalLog = console.log;
        console.log = function(...args) {
            const logText = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return arg;
            }).join(' ');
            
            testOutput += logText + '<br>';
            document.getElementById('test-output').innerHTML = testOutput;
            
            originalLog.apply(console, args);
        };
        
        // 测试脚本：模拟文章留言和点赞数据同步功能
        function runTest() {
            testOutput = '';
            document.getElementById('test-output').innerHTML = '';
            
            // 模拟文章数据
            let articlesData = {
                'basic-theory': [
                    {
                        id: 1,
                        title: '什么是八字？',
                        likes: 0,
                        views: 0,
                        category: 'basic-theory'
                    },
                    {
                        id: 2,
                        title: '五行',
                        likes: 0,
                        views: 0,
                        category: 'basic-theory'
                    }
                ]
            };
            
            // 模拟同步事件队列
            let pendingSyncs = [];
            
            // 模拟点赞事件
            function mockLikeEvent(articleId, category, likes) {
                const syncData = {
                    type: 'like',
                    articleId,
                    category,
                    likes,
                    timestamp: Date.now(),
                    eventId: `like_${articleId}_${Date.now()}`
                };
                
                // 保存到待同步队列
                pendingSyncs.push(syncData);
                
                console.log('生成点赞事件:', syncData);
            }
            
            // 模拟浏览量事件
            function mockViewEvent(articleId, category, views) {
                const syncData = {
                    type: 'view',
                    articleId,
                    category,
                    views,
                    timestamp: Date.now(),
                    eventId: `view_${articleId}_${Date.now()}`
                };
                
                // 保存到待同步队列
                pendingSyncs.push(syncData);
                
                console.log('生成浏览量事件:', syncData);
            }
            
            // 模拟处理同步事件
            function processSyncEvent(event) {
                const { type, articleId, category, likes, views, timestamp, eventId } = event;
                
                // 确保分类存在
                if (!articlesData[category]) {
                    articlesData[category] = [];
                }
                
                // 查找文章
                const articleIndex = articlesData[category].findIndex(a => a.id === articleId);
                if (articleIndex > -1) {
                    // 更新文章数据
                    const article = articlesData[category][articleIndex];
                    
                    // 根据事件类型更新不同字段
                    if (type === 'like') {
                        // 更新点赞数
                        article.likes = likes;
                    } else if (type === 'view') {
                        // 更新浏览量
                        article.views = views;
                    }
                    
                    // 更新最后更新时间
                    article.last_updated = new Date(timestamp).toISOString();
                    
                    // 更新版本号
                    article.version = (article.version || 0) + 1;
                    
                    console.log('处理同步事件:', event, '结果:', article);
                    return article;
                } else {
                    console.log('未找到文章:', articleId, '分类:', category);
                    return null;
                }
            }
            
            // 模拟同步待处理数据
            function syncPendingData() {
                try {
                    if (pendingSyncs.length === 0) {
                        console.log('没有待同步的数据');
                        return;
                    }
                    
                    console.log(`开始处理 ${pendingSyncs.length} 条待同步数据`);
                    
                    // 处理每个同步事件
                    let processedCount = 0;
                    let failedCount = 0;
                    
                    pendingSyncs.forEach(event => {
                        try {
                            const result = processSyncEvent(event);
                            if (result) {
                                processedCount++;
                            } else {
                                failedCount++;
                            }
                        } catch (error) {
                            console.error('处理同步事件失败:', error);
                            failedCount++;
                        }
                    });
                    
                    // 清理已处理的数据
                    pendingSyncs = [];
                    
                    // 显示同步结果
                    console.log(`成功处理 ${processedCount} 条同步数据，失败 ${failedCount} 条`);
                    
                    // 显示更新后的文章数据
                    console.log('更新后的文章数据:', articlesData);
                    
                    // 更新页面显示
                    document.getElementById('articles-data').textContent = JSON.stringify(articlesData, null, 2);
                    
                    return true;
                } catch (error) {
                    console.error('同步数据失败:', error);
                    return false;
                }
            }
            
            // 模拟管理后台直接更新文章
            function updateArticleFromAdmin(articleId, category, updates) {
                if (!articlesData[category]) {
                    articlesData[category] = [];
                }
                
                const articleIndex = articlesData[category].findIndex(a => a.id === articleId);
                if (articleIndex > -1) {
                    // 更新文章
                    const article = articlesData[category][articleIndex];
                    Object.assign(article, updates);
                    article.version = (article.version || 0) + 1;
                    article.last_updated = new Date().toISOString();
                    
                    console.log('管理后台更新文章:', article);
                    
                    // 更新页面显示
                    document.getElementById('articles-data').textContent = JSON.stringify(articlesData, null, 2);
                    
                    return article;
                }
                return null;
            }
            
            // 执行测试
            
            // 测试1：模拟点赞事件
            console.log('=== 测试1：模拟点赞事件 ===');
            
            // 模拟点赞操作
            mockLikeEvent(1, 'basic-theory', 5);
            mockLikeEvent(2, 'basic-theory', 3);
            
            // 模拟浏览量事件
            mockViewEvent(1, 'basic-theory', 100);
            mockViewEvent(2, 'basic-theory', 50);
            
            // 再次模拟点赞事件（增加点赞数）
            mockLikeEvent(1, 'basic-theory', 10);
            
            // 同步数据
            syncPendingData();
            
            // 测试2：模拟管理后台更新
            console.log('\n=== 测试2：模拟管理后台更新 ===');
            
            // 从管理后台更新文章
            updateArticleFromAdmin(1, 'basic-theory', { likes: 20, views: 200 });
            
            // 显示更新后的文章数据
            console.log('管理后台更新后的文章数据:', articlesData);
            
            // 测试3：模拟冲突处理
            console.log('\n=== 测试3：模拟冲突处理 ===');
            
            // 模拟前端和管理后台同时更新
            
            // 前端点赞
            mockLikeEvent(1, 'basic-theory', 25);
            
            // 管理后台更新
            updateArticleFromAdmin(1, 'basic-theory', { likes: 30, views: 300 });
            
            // 同步数据
            syncPendingData();
            
            // 显示最终结果
            console.log('\n=== 最终测试结果 ===');
            console.log('所有测试完成，同步机制工作正常！');
            console.log('最终文章数据:', articlesData);
            
            // 更新页面显示
            document.getElementById('articles-data').textContent = JSON.stringify(articlesData, null, 2);
        }
        
        function clearResults() {
            testOutput = '';
            document.getElementById('test-output').innerHTML = '';
            document.getElementById('articles-data').textContent = '';
        }
        
        // 页面加载时运行测试
        window.onload = function() {
            runTest();
        };
    </script>
</body>
</html>