<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章详情 - 正缘方位网</title>
    <meta name="description" content="正缘方位网文章详情页面">
    <meta name="keywords" content="文章详情,八字命理,命学基础">
    
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 引入中国风字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 文章数据管理脚本 -->
    <script src="articles.js"></script>
    
    <style>
        /* 全局样式 */
        :root {
            --primary-color: #333;
            --text-color: #333;
            --light-text: #666;
            --background-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部样式 */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-light);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: var(--primary-color);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .back-btn:hover {
            background-color: #555;
        }
        
        /* 主要内容样式 */
        main {
            flex: 1;
        }
        
        .main-content {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        /* 文章详情样式 */
        .article-detail {
            padding: 0;
            background: none;
            box-shadow: none;
            border-radius: 0;
        }
        
        .article-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            line-height: 1.3;
        }
        
        .article-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--light-text);
            font-size: 0.9rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .article-content {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        
        .article-content p {
            margin-bottom: 1.5rem;
        }
        
        .article-content h3 {
            margin: 2rem 0 1rem;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .article-content h4 {
            margin: 1.5rem 0 1rem;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        
        /* 文章图片样式 */
        .article-image-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        .article-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 文章视频样式 */
        .article-video-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        .article-video {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 文章文本样式 */
        .article-text {
            margin: 1rem 0;
        }
        
        /* 文章操作样式 */
        .article-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        
        .like-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background-color: transparent;
            color: var(--light-text);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .like-btn:hover {
            background-color: #ffebee;
            color: #e53935;
            border-color: #e53935;
        }
        
        .like-btn.liked {
            background-color: #ffebee;
            color: #e53935;
            border-color: #e53935;
        }
        
        /* 分享按钮样式 */
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1rem;
        }
        
        .share-btn:hover {
            background-color: #555;
        }
        
        /* 分享弹窗样式 */
        .share-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .share-modal {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-medium);
        }
        
        .share-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .share-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: var(--background-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100px;
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
        }
        
        .share-option:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        
        .share-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .share-option span {
            font-size: 0.9rem;
        }
        
        .share-modal .close-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        
        /* 页脚样式 */
        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 4rem;
            border-top: 1px solid var(--border-color);
            color: var(--light-text);
            font-size: 0.9rem;
            background-color: var(--card-bg);
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 错误信息样式 */
        .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--light-text);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .article-title {
                font-size: 1.5rem;
            }
            
            .article-meta {
                flex-direction: column;
                gap: 1rem;
            }
            
            .article-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .article-detail {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">正缘方位网</a>
        </div>
    </header>
    
    <!-- 主要内容 -->
    <main class="main-content">
        <div id="article-detail" class="article-detail" style="display: none;">
            <!-- 文章标题 -->
            <h1 class="article-title" id="article-title"></h1>
            
            <!-- 文章元信息 -->
            <div class="article-meta">
                <div class="meta-item">
                    <i class="fa fa-calendar"></i>
                    <span id="article-date"></span>
                </div>
                <div class="meta-item">
                    <i class="fa fa-folder"></i>
                    <span id="article-category"></span>
                </div>
                <div class="meta-item">
                    <i class="fa fa-eye"></i>
                    <span id="article-views"></span>
                </div>
            </div>
            
            <!-- 文章内容 -->
            <div class="article-content" id="article-content"></div>
            
            <!-- 文章操作 -->
            <div class="article-actions">
                <button class="like-btn" id="like-btn">
                    <i class="fa fa-heart"></i>
                    <span id="like-count"></span>
                </button>
                <button class="share-btn" id="share-btn">
                    <i class="fa fa-share-alt"></i>
                    分享
                </button>
            </div>
        </div>
        
        <!-- 错误信息 -->
        <div id="error-message" class="error-message" style="display: none;">
            <h2>文章不存在或已被删除</h2>
            <p>请返回首页查看其他文章</p>
            <a href="index.html" class="back-btn" style="display: inline-flex; margin-top: 1rem;">
                <i class="fa fa-home"></i>
                返回首页
            </a>
        </div>
    </main>
    
    <!-- 页脚 -->
    <footer>
        <div class="footer-container">
            <p>苏ICP备2025226852号-1丨苏公网安备32020602003711号</p>
        </div>
    </footer>
    
    <!-- 引入模拟API服务 -->

    
    <script>
        // 文章数据
        let articles = {};
        
        // 从后台获取最新文章数据
    async function fetchLatestArticlesFromApi() {
        try {
            const response = await fetch('/api/v1/articles');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiResponse = await response.json();
            if (apiResponse.code === 200 && apiResponse.data && apiResponse.data.articles) {
                return apiResponse.data.articles;
            } else if (apiResponse.code === 200 && apiResponse.data) {
                // 如果返回的数据直接是文章对象，而不是包含articles字段，直接返回
                return apiResponse.data;
            }
            return null;
        } catch (error) {
            console.error('从后台获取文章数据失败:', error);
            return null;
        }
    }

    // 合并本地数据和后台数据
    function mergeArticlesData(localData, apiData) {
        // 如果没有后台数据，直接返回本地数据
        if (!apiData) {
            return localData;
        }
        
        // 创建分类映射，方便查找
        const categoryMap = {};
        Object.keys(localData).forEach(category => {
            categoryMap[category] = new Map();
            localData[category].forEach(article => {
                categoryMap[category].set(article.id, article);
            });
        });
        
        // 合并后台数据到本地数据
        const mergedData = { ...localData };
        
        // 确保所有分类都有数据
        ['basic-theory', 'celebrity-views', 'flower-fruit-method', 'essays'].forEach(category => {
            if (!mergedData[category]) {
                mergedData[category] = [];
                categoryMap[category] = new Map();
            }
        });
        
        // 遍历后台数据，合并到本地数据
        Object.keys(apiData).forEach(category => {
            if (!mergedData[category]) {
                mergedData[category] = [];
                categoryMap[category] = new Map();
            }
            
            apiData[category].forEach(apiArticle => {
                const localArticle = categoryMap[category].get(apiArticle.article_id || apiArticle.id);
                
                if (localArticle) {
                    // 合并数据，优先保留本地修改的精华状态等，使用后台的点赞和浏览量
                    localArticle.likes = apiArticle.likes || localArticle.likes || 0;
                    localArticle.views = apiArticle.views || localArticle.views || 0;
                    localArticle.last_updated = apiArticle.last_updated || localArticle.last_updated || new Date().toISOString();
                    localArticle.version = apiArticle.version || (localArticle.version || 0) + 1;
                } else {
                    // 添加新文章
                    mergedData[category].push({
                        id: apiArticle.article_id || apiArticle.id,
                        title: apiArticle.title || '未命名文章',
                        excerpt: apiArticle.excerpt || '',
                        content: apiArticle.content || '',
                        date: apiArticle.date || apiArticle.last_updated?.split('T')[0] || new Date().toISOString().split('T')[0],
                        likes: apiArticle.likes || 0,
                        views: apiArticle.views || 0,
                        isFeatured: apiArticle.isFeatured || false,
                        images: Array.isArray(apiArticle.images) ? apiArticle.images : [],
                        category: apiArticle.category || category,
                        last_updated: apiArticle.last_updated || new Date().toISOString(),
                        version: apiArticle.version || 1
                    });
                }
            });
        });
        
        return mergedData;
    }

    // 页面加载时执行
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM加载完成，开始加载文章数据');
        
        // 先尝试从localStorage加载数据
        const savedData = localStorage.getItem('articlesData');
        let localData = {};
        if (savedData) {
            try {
                console.log('尝试从localStorage加载数据');
                localData = JSON.parse(savedData);
            } catch (error) {
                console.error('从localStorage解析数据失败:', error);
                localData = {};
            }
        } else {
            console.log('localStorage中没有数据');
        }
        
        // 确保所有分类都有数据
        ['basic-theory', 'celebrity-views', 'flower-fruit-method', 'essays'].forEach(category => {
            if (!localData[category]) {
                localData[category] = [];
            }
        });
        
        // 尝试从后台获取最新数据
        const apiData = await fetchLatestArticlesFromApi();
        
        if (apiData) {
            console.log('从后台获取到最新数据，开始合并数据');
            // 合并后台数据和本地数据
            articles = mergeArticlesData(localData, apiData);
            // 保存到本地存储
            localStorage.setItem('articlesData', JSON.stringify(articles));
            console.log('数据合并完成，保存到localStorage');
            // 加载文章详情
            await loadArticleDetail();
            return;
        }
        
        // 如果无法从后台获取数据，使用本地数据
        if (savedData) {
            console.log('使用localStorage数据');
            articles = localData;
            // 加载文章详情
            await loadArticleDetail();
            return;
        }
        
        // 尝试从articles.json加载数据
        console.log('尝试从articles.json加载数据');
        try {
            const response = await fetch('articles.json');
            if (response.ok) {
                const jsonData = await response.json();
                console.log('成功从articles.json加载数据');
                articles = jsonData;
                // 保存到localStorage
                localStorage.setItem('articlesData', JSON.stringify(articles));
                // 加载文章详情
                await loadArticleDetail();
                return;
            }
        } catch (error) {
            console.error('从articles.json加载数据失败:', error);
        }
        
        // 使用直接嵌入的默认文章数据
        console.log('使用直接嵌入的默认文章数据');
        articles = {
            "basic-theory": [
                {
                    "id": 1,
                    "title": "什么是八字？",
                    "excerpt": "“八字”也叫“生辰八字”，是指一个人出生时的年、月、日、时所对应的天干地支。",
                    "content": "“八字”也叫“生辰八字”，是指一个人出生时的年、月、日、时所对应的天干地支。天干有十个，分别是甲、乙、丙、丁、戊、己、庚、辛、壬、癸；地支有十二个，分别是子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥。天干和地支按照一定的顺序组合起来，形成六十个不同的组合，这就是“六十甲子”。",
                    "date": "2025-12-22",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "basic-theory"
                },
                {
                    "id": 2,
                    "title": "五行",
                    "excerpt": "木火土金水。",
                    "content": "木火土金水。生：木生火，火生土，土生金，金生水，水生木循环往复；克：木克土，土克水，水克火，火克金，金克木。",
                    "date": "2025-12-23",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "basic-theory"
                }
            ],
            "celebrity-views": [
                {
                    "id": 1,
                    "title": "慈禧太后八字",
                    "excerpt": "如果也不具备党势那么还可以看象，象法难度比较大但精准，是命理师不断专研学习的必经之路。",
                    "content": "乙    丁    乙    己\n未    亥    丑    卯\n全局八个字皆有用，无一字浪费和搞破坏不和谐，所以能掌皇权。",
                    "date": "2025-12-23",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "celebrity-views"
                },
                {
                    "id": 2,
                    "title": "李嘉诚八字",
                    "excerpt": "李嘉诚八字的详细分析。",
                    "content": "李嘉诚八字：\n戊 己 庚 丁\n辰 未 午 亥\n\n不知道此时辰是否真伪，但目前是网络上比较公认的时辰。",
                    "date": "2025-12-24",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "celebrity-views"
                }
            ],
            "flower-fruit-method": [
                {
                    "id": 1,
                    "title": "大运流年以及命局的作用关系",
                    "excerpt": "重点：先说清楚大运流年和原局的关系，流年可以作用大运和原局。",
                    "content": "重点：先说清楚大运流年和原局的关系，流年可以作用大运和原局；大运可以作用原局；原局不能反向作用大运和流年，同样大运也不能作用于流年。",
                    "date": "2025-12-23",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "flower-fruit-method"
                }
            ],
            "essays": [
                {
                    "id": 1,
                    "title": "长生十二宫",
                    "excerpt": "现在长生十二宫目前存在两种争议。",
                    "content": "现在长生十二宫目前存在两种争议。a.阴阳同生共死 b.阳生阴死，阴生阳死",
                    "date": "2025-12-23",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "essays"
                },
                {
                    "id": 2,
                    "title": "刑冲合害破合的概念",
                    "excerpt": "首先分为天干五合，地支六合和三合。",
                    "content": "首先分为天干五合，地支六合和三合。1.6.1.天干五合：天干一共 10 位两两相合，所以一共有 5 对相合。",
                    "date": "2025-12-23",
                    "likes": 0,
                    "views": 0,
                    "isFeatured": true,
                    "images": [],
                    "category": "essays"
                }
            ]
        };
        
        // 保存到localStorage
        localStorage.setItem('articlesData', JSON.stringify(articles));
        
        // 加载文章详情
        await loadArticleDetail();
    });
    
    // 直接获取单篇文章的函数
    async function fetchArticle(articleId, category) {
        try {
            let url = `/api/v1/articles/${articleId}?category=${category}`;
            console.log('直接调用fetch获取文章:', url);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP错误! 状态: ${response.status}`);
            }
            const result = await response.json();
            return result.code === 200 ? result.data : null;
        } catch (error) {
            console.error('直接调用fetch获取文章失败:', error);
            return null;
        }
    }

    // 加载文章详情
    async function loadArticleDetail() {
            // 获取URL参数
            const params = new URLSearchParams(window.location.search);
            const id = parseInt(params.get('id'));
            const category = params.get('category');
            
            console.log('获取到的URL参数:', { id, category });
            
            // 检查参数是否存在
            if (!id || !category || isNaN(id)) {
                console.error('缺少必要的文章参数或ID无效');
                showError('缺少必要的文章参数或ID无效');
                return;
            }
            
            // 从localStorage获取最新文章数据
            let articlesData = articles;
            const savedData = localStorage.getItem('articlesData');
            if (savedData) {
                try {
                    articlesData = JSON.parse(savedData);
                    console.log('使用localStorage中的最新文章数据');
                } catch (error) {
                    console.error('解析localStorage数据失败:', error);
                }
            }
            
            // 检查分类是否存在
            if (!articlesData[category]) {
                articlesData[category] = [];
            }
            
            // 查找对应文章
            let article = articlesData[category].find(article => article.id === id);
            
            console.log('查找文章结果:', article);
            console.log('分类', category, '中的所有文章:', articlesData[category]);
            
            // 如果本地找不到文章，尝试从服务器获取
            if (!article) {
                console.log('本地未找到文章，尝试从服务器获取...');
                article = await fetchArticle(id, category);
                console.log('从服务器获取文章结果:', article);
            }
            
            // 转换文章格式，确保id字段存在
            if (article) {
                // 如果文章数据来自服务器，可能使用article_id而不是id
                if (article.article_id && !article.id) {
                    article.id = article.article_id;
                }
            }
            
            if (!article) {
                console.error('找不到指定的文章，ID:', id, '分类:', category);
                showError('找不到指定的文章');
                return;
            }
            
            // 如果从服务器获取到文章，更新本地数据
            if (article && !articlesData[category].some(a => a.id === article.id)) {
                articlesData[category].push(article);
                localStorage.setItem('articlesData', JSON.stringify(articlesData));
                console.log('已将服务器获取的文章添加到本地存储');
            }
            
            // 显示文章
            displayArticle(article);
        }
        
        // 监听数据更新事件，重新加载文章
        window.addEventListener('articlesDataUpdated', (event) => {
            console.log('检测到文章数据更新，重新加载文章详情...');
            loadArticleDetail();
        });
        
        // 显示文章详情
        function displayArticle(article) {
            const articleDiv = document.getElementById('article-detail');
            const errorDiv = document.getElementById('error-message');
            
            // 更新文章标题
            document.getElementById('article-title').textContent = article.title;
            
            // 更新浏览量
            article.views = (article.views || 0) + 1;
            
            // 更新文章元信息
            document.getElementById('article-date').textContent = article.date;
            document.getElementById('article-category').textContent = getCategoryName(article.category);
            document.getElementById('article-views').textContent = article.views;
            document.getElementById('like-count').textContent = article.likes || 0;
            
            // 更新文章内容
            const contentDiv = document.getElementById('article-content');
            let contentHTML = '';
            
            // 添加文章图片
            if (article.images && article.images.length > 0) {
                article.images.forEach(imageUrl => {
                    contentHTML += `<div class="article-image-container">
                        <img src="${imageUrl}" alt="文章图片" class="article-image">
                    </div>`;
                });
            }
            
            // 添加文章内容
            contentHTML += `<div class="article-text">${article.content.replace(/\n/g, '<br>')}</div>`;
            
            // 添加文章视频
            if (article.videos && article.videos.length > 0) {
                article.videos.forEach(videoUrl => {
                    contentHTML += `<div class="article-video-container">
                        <video controls class="article-video">
                            <source src="${videoUrl}" type="video/mp4">
                            您的浏览器不支持视频播放。
                        </video>
                    </div>`;
                });
            }
            
            contentDiv.innerHTML = contentHTML;
            
            // 显示文章详情，隐藏错误信息
            articleDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            // 更新本地存储
            updateLocalStorage(article);
            
            // 同步浏览量数据到后台
            syncViewData(article);
            
            // 初始化点赞功能
            initLikeButton(article);
            
            // 初始化分享功能
            initShareButton(article);
        }
        
        // 获取分类名称
        function getCategoryName(category) {
            const categoryNames = {
                'basic-theory': '命学基础',
                'celebrity-views': '名人八字',
                'flower-fruit-method': '花果论心法',
                'essays': '杂谈随笔'
            };
            return categoryNames[category] || category;
        }
        
        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const articleDiv = document.getElementById('article-detail');
            
            errorDiv.innerHTML = `
                <h2>${message}</h2>
                <p>请返回首页查看其他文章</p>
                <a href="index.html" class="back-btn" style="display: inline-flex; margin-top: 1rem;">
                    <i class="fa fa-home"></i>
                    返回首页
                </a>
            `;
            errorDiv.style.display = 'block';
            articleDiv.style.display = 'none';
        }
        
        // 初始化点赞按钮
        function initLikeButton(article) {
            const likeBtn = document.getElementById('like-btn');
            const likeCount = document.getElementById('like-count');
            
            // 添加点击事件
            likeBtn.addEventListener('click', async function() {
                // 使用articleManager处理点赞，确保数据同步到服务器
                if (window.articleManager && window.articleManager.likeArticle) {
                    const result = await window.articleManager.likeArticle(article.id, article.category);
                    if (result.success) {
                        if (likeBtn.classList.contains('liked')) {
                            // 取消点赞
                            likeBtn.classList.remove('liked');
                            article.likes--;
                        } else {
                            // 添加点赞
                            likeBtn.classList.add('liked');
                            article.likes++;
                        }
                        
                        // 更新点赞数显示
                        likeCount.textContent = article.likes;
                        
                        // 更新本地存储
                        await updateLocalStorage(article);
                        
                        // 强制从服务器同步最新数据，确保所有设备数据一致
                        if (window.articleManager.syncLocalStorage) {
                            await window.articleManager.syncLocalStorage();
                        }
                    }
                } else {
                    // 备选方案：直接更新本地数据
                    if (likeBtn.classList.contains('liked')) {
                        // 取消点赞
                        likeBtn.classList.remove('liked');
                        article.likes--;
                    } else {
                        // 添加点赞
                        likeBtn.classList.add('liked');
                        article.likes++;
                    }
                    
                    // 更新点赞数显示
                    likeCount.textContent = article.likes;
                    
                    // 更新本地存储
                    await updateLocalStorage(article);
                    
                    // 同步到管理后台
                    syncLikeData(article);
                }
            });
        }
        
        // 更新本地存储
        async function updateLocalStorage(article) {
            try {
                // 获取当前localStorage中的文章数据
                let savedData = localStorage.getItem('articlesData');
                let articlesData = savedData ? JSON.parse(savedData) : null;
                
                // 如果localStorage中没有数据，尝试从articles.json加载完整数据
                if (!articlesData) {
                    console.log('localStorage中没有文章数据，尝试从articles.json加载');
                    try {
                        const response = await fetch('articles.json');
                        if (response.ok) {
                            articlesData = await response.json();
                            console.log('成功从articles.json加载完整文章数据');
                        } else {
                            // 如果articles.json加载失败，使用直接嵌入的默认数据
                            articlesData = {
                                "basic-theory": [],
                                "celebrity-views": [],
                                "flower-fruit-method": [],
                                "essays": []
                            };
                            console.log('使用默认空数据结构');
                        }
                    } catch (error) {
                        // 如果网络请求失败，使用直接嵌入的默认数据
                        articlesData = {
                            "basic-theory": [],
                            "celebrity-views": [],
                            "flower-fruit-method": [],
                            "essays": []
                        };
                        console.log('使用默认空数据结构');
                    }
                }
                
                // 确保所有分类都存在
                ['basic-theory', 'celebrity-views', 'flower-fruit-method', 'essays'].forEach(category => {
                    if (!articlesData[category]) {
                        articlesData[category] = [];
                    }
                });
                
                // 查找并更新文章
                const articleIndex = articlesData[article.category].findIndex(a => a.id === article.id);
                if (articleIndex > -1) {
                    // 更新现有文章
                    articlesData[article.category][articleIndex] = article;
                } else {
                    // 添加新文章
                    articlesData[article.category].push(article);
                }
                
                // 保存到localStorage
                localStorage.setItem('articlesData', JSON.stringify(articlesData));
                console.log('文章数据已更新到localStorage');
                
                // 触发数据更新事件，通知其他组件
                window.dispatchEvent(new CustomEvent('articlesDataUpdated', { detail: articlesData }));
                
                // 如果有articleManager，调用syncLocalStorage确保数据同步到服务器
                if (window.articleManager && window.articleManager.syncLocalStorage) {
                    await window.articleManager.syncLocalStorage();
                    console.log('数据已同步到服务器');
                }
                
                // 同时更新mockDatabase中的数据，确保admin页面能获取到最新数据
                // 这是一个临时解决方案，实际项目中应该通过API调用来同步数据
                if (window.mockDatabase) {
                    // 确保分类存在
                    if (!window.mockDatabase.articles) {
                        window.mockDatabase.articles = {
                            'basic-theory': [],
                            'celebrity-views': [],
                            'flower-fruit-method': [],
                            'essays': []
                        };
                    }
                    
                    if (!window.mockDatabase.articles[article.category]) {
                        window.mockDatabase.articles[article.category] = [];
                    }
                    
                    // 查找并更新文章
                    const mockArticleIndex = window.mockDatabase.articles[article.category].findIndex(a => a.id === article.id);
                    if (mockArticleIndex > -1) {
                        // 更新现有文章
                        window.mockDatabase.articles[article.category][mockArticleIndex] = {
                            ...window.mockDatabase.articles[article.category][mockArticleIndex],
                            ...article,
                            version: (window.mockDatabase.articles[article.category][mockArticleIndex].version || 0) + 1,
                            last_updated: new Date().toISOString()
                        };
                    } else {
                        // 添加新文章
                        window.mockDatabase.articles[article.category].push({
                            ...article,
                            version: 1,
                            last_updated: new Date().toISOString()
                        });
                    }
                    
                    // 保存到localStorage
                    localStorage.setItem('mockDatabase', JSON.stringify(window.mockDatabase));
                    console.log('文章数据已更新到mockDatabase');
                }
            } catch (error) {
                console.error('更新localStorage失败:', error);
            }
        }
        
        // 同步点赞数据到管理后台
        function syncLikeData(article) {
            // 准备同步数据
            const syncData = {
                type: 'like',
                articleId: article.id,
                category: article.category,
                likes: article.likes,
                timestamp: Date.now(),
                eventId: `like_${article.id}_${Date.now()}`
            };
            
            // 尝试发送到管理后台
            sendSyncRequest('/api/sync/event', syncData);
        }
        
        // 同步浏览量数据到管理后台
        function syncViewData(article) {
            // 准备同步数据
            const syncData = {
                type: 'view',
                articleId: article.id,
                category: article.category,
                views: article.views,
                timestamp: Date.now(),
                eventId: `view_${article.id}_${Date.now()}`
            };
            
            // 尝试发送到管理后台
            sendSyncRequest('/api/sync/event', syncData);
        }
        
        // 发送同步请求
        async function sendSyncRequest(url, data) {
            try {
                // 使用真实API服务同步数据
                const response = await fetch('/api/v1/articles/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Sync successful:', result);
                
                // 清除当前数据的pending状态，因为已经成功同步
                // 不再将成功同步的数据添加到pendingSyncs中
            } catch (error) {
                console.error('Sync request failed:', error);
                // 保存到本地，以便后续重试
                const failedSyncs = JSON.parse(localStorage.getItem('failedSyncs') || '[]');
                failedSyncs.push({ data, error: error.message, timestamp: Date.now() });
                localStorage.setItem('failedSyncs', JSON.stringify(failedSyncs));
            }
        }
        
        // 初始化分享按钮
        function initShareButton(article) {
            const shareBtn = document.getElementById('share-btn');
            
            // 添加点击事件
            shareBtn.addEventListener('click', function() {
                openShareModal(article);
            });
        }
        
        // 打开分享弹窗
        function openShareModal(article) {
            const url = window.location.href;
            const title = article.title;
            const summary = article.excerpt || '';
            
            // 创建分享弹窗HTML，与index.html保持一致
            const shareHTML = `
                <div class="share-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;">
                    <div class="share-modal" style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">分享到</h3>
                        <div class="share-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- 微信分享 -->
                            <button class="share-option-btn wechat-btn" style="padding: 1rem; border: none; border-radius: 8px; background: #07C160; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                                <i class="fa fa-weixin" style="font-size: 1.5rem;"></i>
                                <span>微信</span>
                            </button>
                            
                            <!-- 微博分享 -->
                            <button class="share-option-btn weibo-btn" style="padding: 1rem; border: none; border-radius: 8px; background: #E6162D; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                                <i class="fa fa-weibo" style="font-size: 1.5rem;"></i>
                                <span>微博</span>
                            </button>
                            
                            <!-- X（原Twitter）分享 -->
                            <button class="share-option-btn twitter-btn" style="padding: 1rem; border: none; border-radius: 8px; background: #1DA1F2; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                                <i class="fa fa-twitter" style="font-size: 1.5rem;"></i>
                                <span>X</span>
                            </button>
                            
                            <!-- YouTube分享 -->
                            <button class="share-option-btn youtube-btn" style="padding: 1rem; border: none; border-radius: 8px; background: #FF0000; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                                <i class="fa fa-youtube" style="font-size: 1.5rem;"></i>
                                <span>YouTube</span>
                            </button>
                            
                            <!-- 复制链接 -->
                            <button class="share-option-btn copy-link-btn" style="padding: 1rem; border: none; border-radius: 8px; background: var(--primary-color); color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                                <i class="fa fa-link" style="font-size: 1.5rem;"></i>
                                <span>复制链接</span>
                            </button>
                        </div>
                        <div style="text-align: center;">
                            <button class="close-share-btn" style="padding: 0.75rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', shareHTML);
            
            // 添加事件监听
            const overlay = document.querySelector('.share-overlay');
            const closeBtn = overlay.querySelector('.close-share-btn');
            
            // 关闭弹窗
            closeBtn.addEventListener('click', () => overlay.remove());
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
            
            // 微信分享
            overlay.querySelector('.wechat-btn').addEventListener('click', () => {
                // 创建微信分享弹窗，包含二维码
                const wechatShareHTML = `
                    <div class="wechat-share-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1002; display: flex; justify-content: center; align-items: center;">
                        <div class="wechat-share-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; text-align: center;">
                            <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-color);">微信分享</h3>
                            <p style="margin-bottom: 1.5rem; color: #666;">请使用微信扫描下方二维码分享此文章</p>
                            <div class="qrcode-container" style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 8px; display: flex; justify-content: center;">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin + window.location.pathname)}" alt="微信分享二维码" style="width: 200px; height: 200px;">
                            </div>
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; word-break: break-all; font-size: 0.8rem; color: #666;">
                                <strong>分享链接：</strong><br>${window.location.origin + window.location.pathname}
                            </div>
                            <p style="margin-bottom: 1.5rem; color: #999; font-size: 0.9rem;">
                                提示：扫描后可分享到微信好友、朋友圈或收藏<br>
                                如二维码无法扫描，请手动复制上方链接
                            </p>
                            <button class="copy-wechat-link-btn" style="margin-bottom: 1rem; padding: 0.75rem 1.5rem; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                复制分享链接
                            </button>
                            <button class="close-wechat-share-btn" style="padding: 0.75rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', wechatShareHTML);
                
                // 添加关闭事件
                const wechatOverlay = document.querySelector('.wechat-share-overlay');
                wechatOverlay.querySelector('.close-wechat-share-btn').addEventListener('click', () => wechatOverlay.remove());
                wechatOverlay.addEventListener('click', (e) => {
                    if (e.target === wechatOverlay) wechatOverlay.remove();
                });
                
                // 添加复制链接功能
                wechatOverlay.querySelector('.copy-wechat-link-btn').addEventListener('click', () => {
                    // 创建包含标题和链接的分享文本
                    const shareText = `${title} - 正缘方位网\n\n${url}\n\n快来看看这篇精彩的命理文章吧！`;
                    navigator.clipboard.writeText(shareText)
                        .then(() => {
                            alert('分享链接已复制到剪贴板！');
                        })
                        .catch(err => {
                            console.error('复制失败:', err);
                            alert('复制失败，请手动复制链接');
                        });
                });
            });
            
            // 微博分享
            overlay.querySelector('.weibo-btn').addEventListener('click', () => {
                const weiboUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(summary)}`;
                window.open(weiboUrl, '_blank', 'width=600,height=400');
            });
            
            // X（原Twitter）分享
            overlay.querySelector('.twitter-btn').addEventListener('click', () => {
                const xUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
                window.open(xUrl, '_blank', 'width=600,height=400');
            });
            
            // YouTube分享
            overlay.querySelector('.youtube-btn').addEventListener('click', () => {
                // YouTube主要用于分享视频，这里提供相关提示和链接
                const baseUrl = window.location.origin + window.location.pathname;
                const youtubeShareHTML = `
                    <div class="youtube-share-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1002; display: flex; justify-content: center; align-items: center;">
                        <div class="youtube-share-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; text-align: center;">
                            <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text-color);">YouTube分享</h3>
                            <p style="margin-bottom: 1.5rem; color: #666;">
                                YouTube主要用于分享视频内容。<br>
                                您可以将此链接分享到YouTube视频的描述或评论中。
                            </p>
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; word-break: break-all; font-size: 0.8rem; color: #666;">
                                <strong>文章链接：</strong><br>${baseUrl}
                            </div>
                            <button class="copy-youtube-link-btn" style="margin-bottom: 1rem; padding: 0.75rem 1.5rem; background: #FF0000; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                复制文章链接
                            </button>
                            <button class="close-youtube-share-btn" style="padding: 0.75rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', youtubeShareHTML);
                
                // 添加关闭事件
                const youtubeOverlay = document.querySelector('.youtube-share-overlay');
                youtubeOverlay.querySelector('.close-youtube-share-btn').addEventListener('click', () => youtubeOverlay.remove());
                youtubeOverlay.addEventListener('click', (e) => {
                    if (e.target === youtubeOverlay) youtubeOverlay.remove();
                });
                
                // 添加复制链接功能
                youtubeOverlay.querySelector('.copy-youtube-link-btn').addEventListener('click', () => {
                    // 创建包含标题和链接的分享文本
                    const shareText = `${title} - 正缘方位网\n\n${url}\n\n快来看看这篇精彩的命理文章吧！`;
                    navigator.clipboard.writeText(shareText)
                        .then(() => {
                            alert('文章链接已复制到剪贴板！');
                        })
                        .catch(err => {
                            console.error('复制失败:', err);
                            alert('复制失败，请手动复制链接');
                        });
                });
            });
            
            // 复制链接
            overlay.querySelector('.copy-link-btn').addEventListener('click', () => {
                // 创建包含标题和链接的分享文本
                const shareText = `${title} - 正缘方位网\n\n${url}\n\n快来看看这篇精彩的命理文章吧！`;
                navigator.clipboard.writeText(shareText)
                    .then(() => {
                        alert('链接已复制到剪贴板！');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制链接');
                    });
            });
        }
    </script>
</body>
</html>